<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Startpage · Cloudinary + Firebase Sync</title>
  <style>
    :root{--bg:#0f1115;--card:#151821;--muted:#aab2c0;--text:#e9edf1;--acc:#4ea1ff;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:14px 16px;background:#0c0e12;border-bottom:1px solid #1e2230;position:sticky;top:0}
    .btn{appearance:none;border:1px solid #2a3040;background:#1a1f2b;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#3b4256}
    .btn.primary{background:var(--acc);color:black;border-color:transparent}
    .btn.ghost{background:transparent}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid #1f2432;border-radius:14px;overflow:hidden;position:relative}
    .card > img{width:100%;height:160px;object-fit:cover;display:block;background:#0b0d11;cursor:pointer;transition:opacity 0.2s}
    .card > img:hover{opacity:0.8}
    .row{display:flex;gap:8px;align-items:center}
    .stack{display:flex;flex-direction:column;gap:10px}
    .muted{color:var(--muted)}
    .hidden{display:none!important}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    input, select{background:#161a24;color:var(--text);border:1px solid #2a3040;border-radius:10px;padding:9px 12px;outline:none;width:100%}
    input[type="file"]{padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .chip{font-size:12px;padding:4px 8px;border:1px solid #2a3040;border-radius:999px;color:var(--muted)}
    .thumb-row{display:flex;gap:6px;flex-wrap:wrap}
    .thumb-row img{width:26px;height:26px;object-fit:cover;border-radius:6px;border:1px solid #2a3040}
    .danger{color:#ff647c}
    .progress{height:8px;background:#12151d;border:1px solid #23293a;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;width:0;background:var(--acc);transition:width .2s linear}
    .center{display:flex;align-items:center;justify-content:center}
    
    /* 削除ボタン */
    .delete-btn{
      position:absolute;
      top:8px;
      right:8px;
      background:rgba(255,100,124,0.9);
      color:white;
      border:none;
      border-radius:50%;
      width:28px;
      height:28px;
      cursor:pointer;
      font-size:14px;
      line-height:1;
      opacity:0;
      transition:opacity 0.2s;
    }
    .card:hover .delete-btn{opacity:1}
    .delete-btn:hover{background:rgba(255,100,124,1)}
    
    /* モーダル */
    .modal{
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      background:rgba(0,0,0,0.9);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      cursor:pointer;
    }
    .modal img{
      max-width:90%;
      max-height:90%;
      object-fit:contain;
      border-radius:8px;
    }
    .modal-info{
      position:absolute;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.8);
      color:white;
      padding:8px 16px;
      border-radius:20px;
      font-size:12px;
    }
    
    /* 画像情報 */
    .card-info{
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      background:linear-gradient(transparent, rgba(0,0,0,0.7));
      color:white;
      padding:8px 10px 4px;
      font-size:11px;
      line-height:1.3;
    }
    .card-name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin-bottom:2px;
    }

    /* 設定セクション */
    .config-section{
      background:#1a1f2b;
      border:1px solid #2a3040;
      border-radius:10px;
      padding:12px;
      margin-bottom:16px;
    }
    .config-section h4{margin:0 0 8px;color:var(--acc)}
    
    /* デバッグ用メッセージ */
    .debug{
      position:fixed;
      bottom:10px;
      left:10px;
      background:rgba(0,0,0,0.8);
      color:#4ea1ff;
      padding:4px 8px;
      border-radius:4px;
      font-size:10px;
      z-index:1000;
    }
  </style>
</head>
<body>
  <div id="debugMsg" class="debug">デバッグ情報</div>
  
  <header>
    <div class="row" style="gap:12px">
      <strong>Startpage Sync (Cloudinary)</strong>
      <span id="authState" class="chip">未ログイン</span>
    </div>
    <div class="row" style="gap:8px">
      <button id="btnOpenSettings" class="btn ghost">設定</button>
      <button id="btnLogin" class="btn primary">ログイン</button>
      <button id="btnLogout" class="btn hidden">ログアウト</button>
    </div>
  </header>

  <main class="wrap stack">
    <!-- アップロード / 一覧 -->
    <section id="appSection" class="stack hidden">
      <div class="toolbar">
        <label class="btn">画像を選択<input id="fileInput" type="file" accept="image/*" multiple hidden></label>
        <button id="btnUpload" class="btn" disabled>アップロード</button>
        <span id="uploadHint" class="muted">最大10枚まで同時にアップロードできます</span>
      </div>
      <div id="progressBox" class="progress hidden"><div id="progressBar"></div></div>

      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:10px">
          <span class="muted">合計:</span>
          <strong id="photoCount">0</strong>
        </div>
        <div class="row" style="gap:8px">
          <select id="sortSelect">
            <option value="createdAt_desc">新しい順</option>
            <option value="createdAt_asc">古い順</option>
            <option value="name_asc">名前 A→Z</option>
            <option value="name_desc">名前 Z→A</option>
          </select>
          <input id="searchInput" placeholder="名前で検索" />
        </div>
      </div>

      <div id="photoGrid" class="grid"></div>
      <div id="emptyState" class="center muted" style="padding:40px">まだ写真がありません。上の「画像を選択」からアップロードしてね。</div>
    </section>

    <!-- 設定 -->
    <section id="settingsSection" class="card hidden" style="padding:16px">
      <h3 style="margin:0 0 16px">設定</h3>
      <div class="stack">
        
        <!-- Cloudinary設定 -->
        <div class="config-section">
          <h4>🌥️ Cloudinary設定</h4>
          <div class="stack">
            <input id="cloudinaryCloudName" placeholder="Cloud Name (例: your-cloud-name)" />
            <input id="cloudinaryUploadPreset" placeholder="Upload Preset (例: unsigned_uploads)" />
            <p class="muted" style="margin:0;font-size:12px">
              Cloudinaryの無料アカウントを作成して、Cloud NameとUpload Presetを入力してください。<br>
              <a href="https://cloudinary.com" target="_blank" style="color:var(--acc)">cloudinary.com</a>
            </p>
          </div>
        </div>

        <!-- テーマ設定 -->
        <div class="config-section">
          <h4>🎨 テーマ設定</h4>
          <select id="themeSelect">
            <option value="dark">ダーク</option>
            <option value="light">ライト</option>
          </select>
        </div>

        <div class="row" style="gap:8px;justify-content:flex-end;margin-top:8px">
          <button id="btnCloseSettings" class="btn ghost">閉じる</button>
          <button id="btnSaveSettings" class="btn primary">保存</button>
        </div>
      </div>
    </section>

    <!-- 認証モーダル（簡易） -->
    <section id="authModal" class="card hidden" style="padding:16px;max-width:460px;margin:0 auto">
      <h3 style="margin:0 0 6px">ログイン / 新規登録</h3>
      <p class="muted" style="margin:0 0 12px">メールとパスワードでログインできます。初めてならそのまま登録してください。</p>
      <form id="authForm" class="stack">
        <input id="email" type="email" placeholder="メールアドレス（例: you@example.com）" required />
        <input id="password" type="password" placeholder="パスワード（6文字以上）" minlength="6" required />
        <div class="row" style="justify-content:space-between">
          <button type="submit" class="btn primary" id="btnEmailLogin">メールでログイン</button>
          <button type="button" class="btn" id="btnRegister">新規登録</button>
        </div>
        <div class="row" style="gap:8px;align-items:center;justify-content:center"><span class="muted">または</span></div>
        <button type="button" class="btn" id="btnGoogle">Googleで続行</button>
      </form>
      <p id="authError" class="danger" style="min-height:1.2em"></p>
    </section>

  </main>

  <!-- Firebase SDK (Compat版) - FirestoreとAuthのみ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    // デバッグ用関数
    function debug(msg) {
      console.log('[DEBUG]', msg);
      document.getElementById('debugMsg').textContent = msg;
    }

    // === Firebase 設定 (StorageなしでFirestoreとAuthのみ) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBCkkQGoq6xm9gIi3SXD5ACWyF09_cXo4A",
      authDomain: "phote-ec8f0.firebaseapp.com",
      projectId: "phote-ec8f0",
      messagingSenderId: "325922770311",
      appId: "1:325922770311:web:a39493565961d7ae861722"
    };

    let app, auth, db;

    try {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      debug('Firebase初期化成功 (Firestore + Auth)');
    } catch (error) {
      debug('Firebase初期化エラー: ' + error.message);
      console.error('Firebase初期化エラー:', error);
    }

    // === Cloudinary設定 ===
    let cloudinaryConfig = {
      cloudName: '',
      uploadPreset: ''
    };

    // ========= DOM 参照 =========
    const authState = document.getElementById('authState');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const appSection = document.getElementById('appSection');
    const authModal = document.getElementById('authModal');
    const authForm = document.getElementById('authForm');
    const btnRegister = document.getElementById('btnRegister');
    const btnGoogle = document.getElementById('btnGoogle');
    const authError = document.getElementById('authError');

    const fileInput = document.getElementById('fileInput');
    const btnUpload = document.getElementById('btnUpload');
    const progressBox = document.getElementById('progressBox');
    const progressBar = document.getElementById('progressBar');
    const photoGrid = document.getElementById('photoGrid');
    const emptyState = document.getElementById('emptyState');
    const photoCount = document.getElementById('photoCount');

    const sortSelect = document.getElementById('sortSelect');
    const searchInput = document.getElementById('searchInput');

    const settingsSection = document.getElementById('settingsSection');
    const btnOpenSettings = document.getElementById('btnOpenSettings');
    const btnCloseSettings = document.getElementById('btnCloseSettings');
    const btnSaveSettings = document.getElementById('btnSaveSettings');
    const themeSelect = document.getElementById('themeSelect');
    const cloudinaryCloudName = document.getElementById('cloudinaryCloudName');
    const cloudinaryUploadPreset = document.getElementById('cloudinaryUploadPreset');

    // ========= ユーティリティ =========
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    const show = (el)=> el.classList.remove('hidden');
    const hide = (el)=> el.classList.add('hidden');

    function toast(msg){
      debug(msg);
      console.log(msg);
      const toast = document.createElement('div');
      toast.textContent = msg;
      toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#4ea1ff;color:white;padding:8px 16px;border-radius:8px;z-index:10000;';
      document.body.appendChild(toast);
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 3000);
    }

    // ========= Cloudinary アップロード関数 =========
    async function uploadToCloudinary(file) {
      if (!cloudinaryConfig.cloudName || !cloudinaryConfig.uploadPreset) {
        throw new Error('Cloudinaryの設定が不完全です。設定画面で設定してください。');
      }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', cloudinaryConfig.uploadPreset);
      
      const response = await fetch(
        `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`,
        {
          method: 'POST',
          body: formData
        }
      );

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Cloudinaryアップロードエラー: ${response.status} - ${errorText}`);
      }

      const data = await response.json();
      return {
        url: data.secure_url,
        publicId: data.public_id,
        width: data.width,
        height: data.height,
        format: data.format,
        bytes: data.bytes
      };
    }

    // ========= モーダル関数 =========
    function showImageModal(url, name, size) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      
      const img = document.createElement('img');
      img.src = url;
      img.alt = name;
      
      const info = document.createElement('div');
      info.className = 'modal-info';
      const sizeText = size ? `(${(size/1024/1024).toFixed(1)}MB)` : '';
      info.textContent = `${name} ${sizeText}`;
      
      modal.appendChild(img);
      modal.appendChild(info);
      
      modal.onclick = () => {
        if (document.body.contains(modal)) {
          document.body.removeChild(modal);
        }
      };
      document.body.appendChild(modal);
    }

    // ========= 削除関数 =========
    async function deletePhoto(item) {
      if (!confirm(`「${item.name}」を削除しますか？`)) return;
      
      try {
        debug(`削除開始: ${item.name}`);
        
        // Firestoreから削除
        await db.collection('users').doc(auth.currentUser.uid)
          .collection('photos').doc(item.id).delete();
        
        // Cloudinaryからも削除（オプション）
        if (item.cloudinaryPublicId && cloudinaryConfig.cloudName) {
          try {
            // 注: Cloudinaryからの削除はAPI署名が必要なため、通常はサーバーサイドで行います
            // ここではFirestoreからの削除のみ行います
            debug('Cloudinaryからの削除はスキップ（要署名）');
          } catch (cloudinaryError) {
            debug(`Cloudinary削除エラー: ${cloudinaryError.message}`);
          }
        }
        
        toast('削除しました');
        debug(`削除完了: ${item.name}`);
      } catch(error) {
        console.error('削除エラー:', error);
        debug(`削除エラー: ${error.message}`);
        toast('削除に失敗しました');
      }
    }

    // ========= 認証 UI =========
    btnLogin.addEventListener('click', ()=> {
      debug('ログインボタンクリック');
      show(authModal);
    });
    
    btnLogout.addEventListener('click', async ()=> {
      debug('ログアウト開始');
      await auth.signOut();
    });

    btnOpenSettings.addEventListener('click', ()=> show(settingsSection));
    btnCloseSettings.addEventListener('click', ()=> hide(settingsSection));

    authForm.addEventListener('submit', async (e)=> {
      e.preventDefault();
      authError.textContent = '';
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      debug(`ログイン試行: ${email}`);
      
      try{
        await auth.signInWithEmailAndPassword(email, password);
        hide(authModal);
        debug('ログイン成功');
      }catch(err){ 
        authError.textContent = err.message; 
        debug(`ログインエラー: ${err.message}`);
      }
    });

    btnRegister.addEventListener('click', async ()=> {
      authError.textContent = '';
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      debug(`新規登録試行: ${email}`);
      
      try{
        await auth.createUserWithEmailAndPassword(email, password);
        const uid = auth.currentUser.uid;
        await db.collection('users').doc(uid).set({
          settings: { 
            theme: 'dark',
            cloudinaryCloudName: '',
            cloudinaryUploadPreset: ''
          },
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        hide(authModal);
        debug('新規登録成功');
      }catch(err){ 
        authError.textContent = err.message; 
        debug(`新規登録エラー: ${err.message}`);
      }
    });

    btnGoogle.addEventListener('click', async ()=> {
      authError.textContent = '';
      debug('Google認証開始');
      
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        hide(authModal);
        debug('Google認証成功');
      }catch(err){ 
        authError.textContent = err.message; 
        debug(`Google認証エラー: ${err.message}`);
      }
    });

    // ========= 状態監視 =========
    let unsubPhotos = null;
    auth.onAuthStateChanged(async (user)=> {
      if(user){
        debug(`認証状態変更: ログイン ${user.email || user.uid}`);
        authState.textContent = `ログイン中: ${user.email || user.displayName || user.uid}`;
        hide(btnLogin); show(btnLogout); show(appSection); hide(authModal);

        // 設定読込
        try {
          const userDoc = await db.collection('users').doc(user.uid).get();
          const settings = userDoc.exists && userDoc.data().settings ? userDoc.data().settings : { 
            theme:'dark',
            cloudinaryCloudName: '',
            cloudinaryUploadPreset: ''
          };
          
          // テーマ適用
          applyTheme(settings.theme || 'dark');
          themeSelect.value = settings.theme || 'dark';
          
          // Cloudinary設定読み込み
          cloudinaryConfig.cloudName = settings.cloudinaryCloudName || '';
          cloudinaryConfig.uploadPreset = settings.cloudinaryUploadPreset || '';
          cloudinaryCloudName.value = cloudinaryConfig.cloudName;
          cloudinaryUploadPreset.value = cloudinaryConfig.uploadPreset;
          
          debug('設定読み込み完了');
        } catch (error) {
          debug(`設定読み込みエラー: ${error.message}`);
        }

        // 写真一覧を購読
        subscribePhotos('createdAt_desc');
      } else {
        debug('認証状態変更: ログアウト');
        authState.textContent = '未ログイン';
        show(btnLogin); hide(btnLogout); hide(appSection); hide(settingsSection);
        photoGrid.innerHTML = ''; photoCount.textContent = '0'; show(emptyState);
        if(unsubPhotos){ unsubPhotos(); unsubPhotos = null; }
      }
    });

    // ========= 設定保存 =========
    btnSaveSettings.addEventListener('click', async ()=> {
      const user = auth.currentUser; if(!user) return;
      
      const next = { 
        theme: themeSelect.value,
        cloudinaryCloudName: cloudinaryCloudName.value.trim(),
        cloudinaryUploadPreset: cloudinaryUploadPreset.value.trim()
      };
      
      try {
        await db.collection('users').doc(user.uid).set({ settings: next }, { merge:true });
        
        // Cloudinary設定を更新
        cloudinaryConfig.cloudName = next.cloudinaryCloudName;
        cloudinaryConfig.uploadPreset = next.cloudinaryUploadPreset;
        
        applyTheme(next.theme);
        toast('設定を保存しました');
        hide(settingsSection);
        debug('設定保存完了');
      } catch (error) {
        debug(`設定保存エラー: ${error.message}`);
        toast('設定の保存に失敗しました');
      }
    });

    function applyTheme(mode){
      if(mode==='light'){
        document.documentElement.style.setProperty('--bg','#f6f7fb');
        document.documentElement.style.setProperty('--card','#ffffff');
        document.documentElement.style.setProperty('--text','#0d1117');
        document.documentElement.style.setProperty('--muted','#516079');
        document.documentElement.style.setProperty('--acc','#2563eb');
      } else {
        document.documentElement.style.setProperty('--bg','#0f1115');
        document.documentElement.style.setProperty('--card','#151821');
        document.documentElement.style.setProperty('--text','#e9edf1');
        document.documentElement.style.setProperty('--muted','#aab2c0');
        document.documentElement.style.setProperty('--acc','#4ea1ff');
      }
    }

    // ========= 写真アップロード =========
    let selectedFiles = [];
    fileInput.addEventListener('change', ()=> {
      selectedFiles = Array.from(fileInput.files || []).slice(0,10);
      btnUpload.disabled = selectedFiles.length===0;
      document.getElementById('uploadHint').textContent = selectedFiles.length ? `${selectedFiles.length} 件選択中` : '最大10枚まで同時にアップロードできます';
      debug(`ファイル選択: ${selectedFiles.length}件`);
    });

    btnUpload.addEventListener('click', async ()=> {
      const user = auth.currentUser; 
      if(!user || selectedFiles.length===0) return;
      
      // Cloudinary設定チェック
      if (!cloudinaryConfig.cloudName || !cloudinaryConfig.uploadPreset) {
        toast('Cloudinaryの設定が必要です。設定画面で入力してください。');
        show(settingsSection);
        return;
      }
      
      debug(`アップロード開始: ${selectedFiles.length}件`);
      
      try {
        show(progressBox); 
        progressBar.style.width = '0%';
        btnUpload.disabled = true;

        let completed = 0;
        const total = selectedFiles.length;

        for(let i = 0; i < selectedFiles.length; i++){
          const file = selectedFiles[i];
          debug(`アップロード中 ${i+1}/${total}: ${file.name}`);
          
          try {
            // Cloudinaryにアップロード
            const cloudinaryResult = await uploadToCloudinary(file);
            debug(`Cloudinaryアップロード完了: ${file.name}`);
            
            // Firestoreに保存
            const docData = {
              name: file.name,
              url: cloudinaryResult.url,
              cloudinaryPublicId: cloudinaryResult.publicId,
              size: file.size,
              type: file.type,
              width: cloudinaryResult.width,
              height: cloudinaryResult.height,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              uploadedAt: new Date()
            };
            
            const docRef = await db.collection('users').doc(user.uid)
              .collection('photos').add(docData);
            
            debug(`Firestore保存完了: ${docRef.id} - ${file.name}`);
            
          } catch (fileError) {
            debug(`ファイルアップロードエラー ${file.name}: ${fileError.message}`);
            toast(`${file.name} のアップロードに失敗しました`);
          }
          
          completed++;
          const totalProgress = (completed / total) * 100;
          progressBar.style.width = `${totalProgress}%`;
        }

        await sleep(500);
        debug('全アップロード完了');
        toast(`${completed}件のアップロードが完了しました！`);
        
      } catch(error) {
        console.error('アップロードエラー:', error);
        debug(`アップロード失敗: ${error.message}`);
        toast('アップロードに失敗しました: ' + error.message);
      } finally {
        hide(progressBox); 
        progressBar.style.width = '0%';
        btnUpload.disabled = false;
        selectedFiles = []; 
        fileInput.value = '';
        document.getElementById('uploadHint').textContent = '最大10枚まで同時にアップロードできます';
      }
    });

    // ========= 写真一覧購読 =========
    function subscribePhotos(sortKey){
      const user = auth.currentUser; 
      if(!user) {
        debug('写真購読: ユーザー未ログイン');
        return;
      }

      if(unsubPhotos){ 
        debug('既存の写真購読を解除');
        unsubPhotos(); 
        unsubPhotos = null; 
      }

      debug(`写真購読開始: ${sortKey}`);

      let q = db.collection('users').doc(user.uid).collection('photos');
      
      if(sortKey === 'createdAt_asc') {
        q = q.orderBy('createdAt','asc');
      } else if(sortKey === 'name_asc') {
        q = q.orderBy('name','asc');
      } else if(sortKey === 'name_desc') {
        q = q.orderBy('name','desc');
      } else {
        q = q.orderBy('createdAt','desc');
      }

      unsubPhotos = q.onSnapshot((snap)=> {
        debug(`写真データ受信: ${snap.size}件`);
        const items = [];
        snap.forEach(doc=> {
          const data = doc.data();
          items.push({ id: doc.id, ...data });
        });
        renderPhotos(items);
      }, (error) => {
        debug(`写真購読エラー: ${error.message}`);
        console.error('写真購読エラー:', error);
      });
    }

    sortSelect.addEventListener('change', ()=> {
      debug(`ソート変更: ${sortSelect.value}`);
      subscribePhotos(sortSelect.value);
    });
    
    searchInput.addEventListener('input', ()=> {
      debug(`検索: ${searchInput.value}`);
      subscribePhotos(sortSelect.value);
    });

    function renderPhotos(items){
      debug(`写真描画開始: ${items.length}件`);
      
      const q = (searchInput.value || '').toLowerCase().trim();
      const filtered = q ? items.filter(it=> (it.name||'').toLowerCase().includes(q)) : items;

      photoCount.textContent = String(filtered.length);
      
      if(filtered.length === 0){
        photoGrid.innerHTML = '';
        show(emptyState);
        debug('写真なし - 空状態表示');
        return;
      }
      
      hide(emptyState);

      photoGrid.innerHTML = '';
      filtered.forEach((item, index)=>{
        const div = document.createElement('div');
        div.className = 'card';
        div.title = item.name;
        
        // 画像
        const img = document.createElement('img');
        img.src = item.url;
        img.alt = item.name || 'photo';
        img.loading = 'lazy';
        img.onclick = () => showImageModal(item.url, item.name, item.size);
        
        // 削除ボタン
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.innerHTML = '×';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          deletePhoto(item);
        };
        
        // 画像情報
        const info = document.createElement('div');
        info.className = 'card-info';
        const sizeInMB = item.size ? (item.size/1024/1024).toFixed(1) : '0.0';
        const dimensions = item.width && item.height ? `${item.width}×${item.height}` : '';
        info.innerHTML = `
          <div class="card-name">${item.name || 'unknown'}</div>
          <div>${sizeInMB}MB ${dimensions}</div>
        `;
        
        div.appendChild(img);
        div.appendChild(delBtn);
        div.appendChild(info);
        photoGrid.appendChild(div);
      });
      
      debug(`写真描画完了: ${filtered.length}件表示`);
    }

    // 初期化完了メッセージ
    window.addEventListener('load', () => {
      debug('アプリ初期化完了');
    });
  </script>
</body>
</html>
