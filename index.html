<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Startpage Â· Photo Gallery</title>
  <style>
    :root{--bg:#0f1115;--card:#151821;--muted:#aab2c0;--text:#e9edf1;--acc:#4ea1ff;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:14px 16px;background:#0c0e12;border-bottom:1px solid #1e2230;position:sticky;top:0;z-index:100}
    .btn{appearance:none;border:1px solid #2a3040;background:#1a1f2b;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#3b4256}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .btn.primary{background:var(--acc);color:black;border-color:transparent}
    .btn.ghost{background:transparent}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;padding:8px 0}
    .card{background:var(--card);border:1px solid #1f2432;border-radius:12px;overflow:hidden;position:relative;aspect-ratio:1;cursor:pointer;transition:transform 0.2s, box-shadow 0.2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.3)}
    .card > img{width:100%;height:100%;object-fit:cover;display:block;transition:opacity 0.2s}
    .card > img:hover{opacity:0.9}
    .row{display:flex;gap:8px;align-items:center}
    .stack{display:flex;flex-direction:column;gap:10px}
    .muted{color:var(--muted)}
    .hidden{display:none!important}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    input, select{background:#161a24;color:var(--text);border:1px solid #2a3040;border-radius:10px;padding:9px 12px;outline:none;width:100%}
    input[type="file"]{padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:16px}
    .chip{font-size:12px;padding:4px 8px;border:1px solid #2a3040;border-radius:999px;color:var(--muted)}
    .danger{color:#ff647c}
    .success{color:#4ade80}
    .warning{color:#fbbf24}
    .progress{height:8px;background:#12151d;border:1px solid #23293a;border-radius:999px;overflow:hidden;margin-bottom:16px}
    .progress > div{height:100%;width:0;background:var(--acc);transition:width .2s linear}
    .center{display:flex;align-items:center;justify-content:center}
    
    /* å‰Šé™¤ãƒœã‚¿ãƒ³ */
    .delete-btn{
      position:absolute;
      top:8px;
      right:8px;
      background:rgba(255,100,124,0.9);
      color:white;
      border:none;
      border-radius:50%;
      width:32px;
      height:32px;
      cursor:pointer;
      font-size:16px;
      line-height:1;
      opacity:0;
      transition:opacity 0.2s;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card:hover .delete-btn{opacity:1}
    .delete-btn:hover{background:rgba(255,100,124,1);transform:scale(1.1)}
    
    /* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal{
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      background:rgba(0,0,0,0.95);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      opacity:0;
      animation:fadeIn 0.3s ease-out forwards;
    }
    @keyframes fadeIn{
      to{opacity:1}
    }
    
    .modal-content{
      position:relative;
      max-width:95vw;
      max-height:95vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .modal img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      border-radius:8px;
      box-shadow:0 10px 40px rgba(0,0,0,0.5);
    }
    
    .modal-controls{
      position:absolute;
      top:20px;
      right:20px;
      display:flex;
      gap:8px;
    }
    
    .modal-btn{
      background:rgba(0,0,0,0.7);
      color:white;
      border:none;
      border-radius:50%;
      width:44px;
      height:44px;
      cursor:pointer;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background 0.2s;
    }
    .modal-btn:hover{background:rgba(0,0,0,0.9)}
    
    .modal-info{
      position:absolute;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.8);
      color:white;
      padding:12px 20px;
      border-radius:25px;
      font-size:14px;
      text-align:center;
      max-width:80%;
    }
    
    .modal-nav{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      background:rgba(0,0,0,0.7);
      color:white;
      border:none;
      border-radius:50%;
      width:50px;
      height:50px;
      cursor:pointer;
      font-size:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background 0.2s, opacity 0.2s;
      opacity:0.7;
    }
    .modal-nav:hover{background:rgba(0,0,0,0.9);opacity:1}
    .modal-nav.prev{left:20px}
    .modal-nav.next{right:20px}
    .modal-nav:disabled{opacity:0.3;cursor:not-allowed}
    
    /* ç”»åƒæƒ…å ±ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .card-info{
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      background:linear-gradient(transparent, rgba(0,0,0,0.8));
      color:white;
      padding:12px 8px 6px;
      font-size:10px;
      line-height:1.2;
      opacity:0;
      transition:opacity 0.2s;
    }
    .card:hover .card-info{opacity:1}
    .card-name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:500;
      margin-bottom:2px;
    }

    /* è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .config-section{
      background:#1a1f2b;
      border:1px solid #2a3040;
      border-radius:10px;
      padding:12px;
      margin-bottom:16px;
    }
    .config-section h4{margin:0 0 8px;color:var(--acc)}
    
    /* LoadingçŠ¶æ…‹ */
    .loading{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:40px;
      color:var(--muted);
    }
    .spinner{
      border:2px solid #2a3040;
      border-top:2px solid var(--acc);
      border-radius:50%;
      width:24px;
      height:24px;
      animation:spin 1s linear infinite;
      margin-right:8px;
    }
    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }
    
    /* ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .debug{
      position:fixed;
      bottom:10px;
      left:10px;
      background:rgba(0,0,0,0.8);
      color:#4ea1ff;
      padding:4px 8px;
      border-radius:4px;
      font-size:10px;
      z-index:1000;
      max-width:300px;
      word-break:break-word;
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆ */
    .status-alert {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    .status-alert.error {
      background: rgba(255, 100, 124, 0.1);
      border: 1px solid rgba(255, 100, 124, 0.3);
      color: #ff647c;
    }
    .status-alert.warning {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      color: #fbbf24;
    }
    .status-alert.success {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      color: #4ade80;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:6px}
      .modal-nav{width:40px;height:40px;font-size:16px}
      .modal-nav.prev{left:10px}
      .modal-nav.next{right:10px}
      .modal-controls{top:10px;right:10px}
      .modal-btn{width:40px;height:40px;font-size:16px}
    }
  </style>
</head>
<body>
  <div id="debugMsg" class="debug">åˆæœŸåŒ–ä¸­...</div>
  
  <header>
    <div class="row" style="gap:12px">
      <strong>ğŸ“· Photo Gallery</strong>
      <span id="authState" class="chip">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
    </div>
    <div class="row" style="gap:8px">
      <button id="btnOpenSettings" class="btn ghost">âš™ï¸ è¨­å®š</button>
      <button id="btnLogin" class="btn primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button id="btnLogout" class="btn hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <main class="wrap stack">
    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ / ä¸€è¦§ -->
    <section id="appSection" class="stack hidden">
      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
      <div id="statusAlert" class="status-alert warning hidden">
        <strong>âš ï¸ è¨­å®šãŒå¿…è¦ã§ã™</strong><br>
        Cloudinaryã®è¨­å®šã‚’å®Œäº†ã—ã¦ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
      </div>

      <div class="toolbar">
        <label class="btn primary">ğŸ“ ç”»åƒã‚’é¸æŠ<input id="fileInput" type="file" accept="image/*" multiple hidden></label>
        <button id="btnUpload" class="btn" disabled>â¬†ï¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <span id="uploadHint" class="muted">æœ€å¤§10æšã¾ã§åŒæ™‚ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</span>
      </div>
      <div id="progressBox" class="progress hidden"><div id="progressBar"></div></div>

      <div class="row" style="justify-content:space-between;margin-bottom:16px">
        <div class="row" style="gap:10px">
          <span class="muted">ğŸ“Š åˆè¨ˆ:</span>
          <strong id="photoCount">0</strong>
          <span class="muted">æš</span>
        </div>
        <div class="row" style="gap:8px">
          <select id="sortSelect">
            <option value="createdAt_desc">ğŸ• æ–°ã—ã„é †</option>
            <option value="createdAt_asc">ğŸ• å¤ã„é †</option>
            <option value="name_asc">ğŸ“ åå‰ Aâ†’Z</option>
            <option value="name_desc">ğŸ“ åå‰ Zâ†’A</option>
          </select>
          <input id="searchInput" placeholder="ğŸ” åå‰ã§æ¤œç´¢" style="max-width:200px" />
        </div>
      </div>

      <div id="loadingState" class="loading hidden">
        <div class="spinner"></div>
        å†™çœŸã‚’èª­ã¿è¾¼ã¿ä¸­...
      </div>

      <div id="photoGrid" class="grid"></div>
      <div id="emptyState" class="center muted" style="padding:60px">
        ğŸ“·<br><br>
        ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“<br>
        ä¸Šã®ã€ŒğŸ“ ç”»åƒã‚’é¸æŠã€ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã­
      </div>
    </section>

    <!-- è¨­å®š -->
    <section id="settingsSection" class="card hidden" style="padding:20px;max-width:600px;margin:0 auto">
      <h3 style="margin:0 0 20px">âš™ï¸ è¨­å®š</h3>
      <div class="stack">
        
        <!-- Cloudinaryè¨­å®š -->
        <div class="config-section">
          <h4>ğŸŒ¥ï¸ Cloudinaryè¨­å®š</h4>
          <div class="stack">
            <input id="cloudinaryCloudName" placeholder="Cloud Name (ä¾‹: your-cloud-name)" />
            <input id="cloudinaryUploadPreset" placeholder="Upload Preset (ä¾‹: unsigned_uploads)" />
            <div id="cloudinaryStatus" class="status-alert error">
              <strong>âŒ æœªè¨­å®š</strong><br>
              Cloudinaryã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚ä»¥ä¸‹ã®æ‰‹é †ã§è¨­å®šã—ã¦ãã ã•ã„ï¼š
              <ol style="margin: 8px 0 0 16px; font-size: 12px;">
                <li><a href="https://cloudinary.com" target="_blank" style="color:var(--acc)">cloudinary.com</a> ã§ç„¡æ–™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ</li>
                <li>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã€ŒCloud Nameã€ã‚’ã‚³ãƒ”ãƒ¼</li>
                <li>Settings â†’ Upload â†’ Upload presets ã§ã€Œunsignedã€ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½œæˆ</li>
                <li>ä¸Šè¨˜ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ä¿å­˜</li>
              </ol>
            </div>
            <button id="btnTestCloudinary" class="btn ghost" disabled>ğŸ§ª æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
          </div>
        </div>

        <!-- ãƒ†ãƒ¼ãƒè¨­å®š -->
        <div class="config-section">
          <h4>ğŸ¨ ãƒ†ãƒ¼ãƒè¨­å®š</h4>
          <select id="themeSelect">
            <option value="dark">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</option>
            <option value="light">â˜€ï¸ ãƒ©ã‚¤ãƒˆ</option>
          </select>
        </div>

        <div class="row" style="gap:8px;justify-content:flex-end;margin-top:16px">
          <button id="btnCloseSettings" class="btn ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="btnSaveSettings" class="btn primary">ğŸ’¾ ä¿å­˜</button>
        </div>
      </div>
    </section>

    <!-- èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <section id="authModal" class="card hidden" style="padding:20px;max-width:460px;margin:0 auto">
      <h3 style="margin:0 0 8px">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h3>
      <p class="muted" style="margin:0 0 16px">ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚åˆã‚ã¦ãªã‚‰ãã®ã¾ã¾ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
      <form id="authForm" class="stack">
        <input id="email" type="email" placeholder="ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹: you@example.comï¼‰" required />
        <input id="password" type="password" placeholder="ğŸ”’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰" minlength="6" required />
        <div class="row" style="justify-content:space-between">
          <button type="submit" class="btn primary" id="btnEmailLogin">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button type="button" class="btn" id="btnRegister">âœ¨ æ–°è¦ç™»éŒ²</button>
        </div>
        <div class="row" style="gap:8px;align-items:center;justify-content:center;margin:8px 0">
          <span class="muted">ã¾ãŸã¯</span>
        </div>
        <button type="button" class="btn" id="btnGoogle">ğŸ” Googleã§ç¶šè¡Œ</button>
      </form>
      <p id="authError" class="danger" style="min-height:1.5em;margin-top:12px"></p>
    </section>

  </main>

  <!-- Firebase SDK (Compatç‰ˆ) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    // ãƒ‡ãƒãƒƒã‚°ç”¨é–¢æ•°
    function debug(msg) {
      console.log('[DEBUG]', msg);
      const debugEl = document.getElementById('debugMsg');
      if (debugEl) {
        debugEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      }
    }

    // === Firebase è¨­å®š ===
    const firebaseConfig = {
      apiKey: "AIzaSyBCkkQGoq6xm9gIi3SXD5ACWyF09_cXo4A",
      authDomain: "phote-ec8f0.firebaseapp.com",
      projectId: "phote-ec8f0",
      messagingSenderId: "325922770311",
      appId: "1:325922770311:web:a39493565961d7ae861722"
    };

    let app, auth, db;

    try {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      debug('FirebaseåˆæœŸåŒ–æˆåŠŸ');
    } catch (error) {
      debug('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
      console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    }

    // === Cloudinaryè¨­å®š ===
    let cloudinaryConfig = {
      cloudName: '',
      uploadPreset: ''
    };

    // å†™çœŸãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    let allPhotos = [];
    let currentPhotoIndex = 0;

    // ========= DOM å‚ç…§ =========
    const authState = document.getElementById('authState');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const appSection = document.getElementById('appSection');
    const authModal = document.getElementById('authModal');
    const authForm = document.getElementById('authForm');
    const btnRegister = document.getElementById('btnRegister');
    const btnGoogle = document.getElementById('btnGoogle');
    const authError = document.getElementById('authError');

    const fileInput = document.getElementById('fileInput');
    const btnUpload = document.getElementById('btnUpload');
    const progressBox = document.getElementById('progressBox');
    const progressBar = document.getElementById('progressBar');
    const photoGrid = document.getElementById('photoGrid');
    const emptyState = document.getElementById('emptyState');
    const loadingState = document.getElementById('loadingState');
    const photoCount = document.getElementById('photoCount');

    const sortSelect = document.getElementById('sortSelect');
    const searchInput = document.getElementById('searchInput');

    const settingsSection = document.getElementById('settingsSection');
    const btnOpenSettings = document.getElementById('btnOpenSettings');
    const btnCloseSettings = document.getElementById('btnCloseSettings');
    const btnSaveSettings = document.getElementById('btnSaveSettings');
    const themeSelect = document.getElementById('themeSelect');
    const cloudinaryCloudName = document.getElementById('cloudinaryCloudName');
    const cloudinaryUploadPreset = document.getElementById('cloudinaryUploadPreset');
    const cloudinaryStatus = document.getElementById('cloudinaryStatus');
    const btnTestCloudinary = document.getElementById('btnTestCloudinary');
    const statusAlert = document.getElementById('statusAlert');

    // ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =========
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    const show = (el)=> el.classList.remove('hidden');
    const hide = (el)=> el.classList.add('hidden');

    function toast(msg, type = 'info'){
      debug(msg);
      console.log(msg);
      const toast = document.createElement('div');
      toast.textContent = msg;
      const bgColor = type === 'error' ? '#ff647c' : type === 'success' ? '#4ade80' : '#4ea1ff';
      toast.style.cssText = `position:fixed;top:20px;right:20px;background:${bgColor};color:white;padding:12px 16px;border-radius:8px;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.3);animation:slideIn 0.3s ease-out;max-width:300px;`;
      document.body.appendChild(toast);
      setTimeout(() => {
        if (document.body.contains(toast)) {
          toast.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => {
            if (document.body.contains(toast)) {
              document.body.removeChild(toast);
            }
          }, 300);
        }
      }, type === 'error' ? 5000 : 3000);
    }

    // CSS for toast animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // ========= Cloudinary é–¢æ•° =========
    function validateCloudinaryConfig() {
      const isValid = cloudinaryConfig.cloudName && cloudinaryConfig.uploadPreset;
      
      if (isValid) {
        cloudinaryStatus.className = 'status-alert success';
        cloudinaryStatus.innerHTML = '<strong>âœ… è¨­å®šå®Œäº†</strong><br>Cloudinaryã®è¨­å®šãŒæ­£å¸¸ã«å®Œäº†ã—ã¦ã„ã¾ã™ã€‚';
        btnTestCloudinary.disabled = false;
        hide(statusAlert);
      } else {
        cloudinaryStatus.className = 'status-alert error';
        cloudinaryStatus.innerHTML = `
          <strong>âŒ æœªè¨­å®š</strong><br>
          Cloudinaryã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚ä»¥ä¸‹ã®æ‰‹é †ã§è¨­å®šã—ã¦ãã ã•ã„ï¼š
          <ol style="margin: 8px 0 0 16px; font-size: 12px;">
            <li><a href="https://cloudinary.com" target="_blank" style="color:var(--acc)">cloudinary.com</a> ã§ç„¡æ–™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ</li>
            <li>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã€ŒCloud Nameã€ã‚’ã‚³ãƒ”ãƒ¼</li>
            <li>Settings â†’ Upload â†’ Upload presets ã§ã€Œunsignedã€ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½œæˆ</li>
            <li>ä¸Šè¨˜ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ä¿å­˜</li>
          </ol>
        `;
        btnTestCloudinary.disabled = true;
        
        // ãƒ¡ã‚¤ãƒ³ç”»é¢ã«ã‚‚è­¦å‘Šè¡¨ç¤º
        statusAlert.innerHTML = `
          <strong>âš ï¸ è¨­å®šãŒå¿…è¦ã§ã™</strong><br>
          Cloudinaryã®è¨­å®šã‚’å®Œäº†ã—ã¦ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
        `;
        show(statusAlert);
      }
      
      return isValid;
    }

    // Cloudinaryæ¥ç¶šãƒ†ã‚¹ãƒˆ
    async function testCloudinaryConnection() {
      if (!validateCloudinaryConfig()) {
        toast('Cloudinaryã®è¨­å®šãŒä¸å®Œå…¨ã§ã™', 'error');
        return false;
      }

      try {
        debug('Cloudinaryæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
        btnTestCloudinary.disabled = true;
        btnTestCloudinary.textContent = 'ğŸ”„ ãƒ†ã‚¹ãƒˆä¸­...';

        // å°ã•ãªãƒ†ã‚¹ãƒˆç”»åƒã‚’ä½œæˆï¼ˆ1x1ãƒ”ã‚¯ã‚»ãƒ«ã®é€æ˜PNGï¼‰
        const canvas = document.createElement('canvas');
        canvas.width = 1;
        canvas.height = 1;
        const testBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));

        const formData = new FormData();
        formData.append('file', testBlob, 'test.png');
        formData.append('upload_preset', cloudinaryConfig.uploadPreset);

        const response = await fetch(
          `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`,
          {
            method: 'POST',
            body: formData
          }
        );

        if (response.ok) {
          const data = await response.json();
          debug('Cloudinaryæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ');
          toast('Cloudinaryã®æ¥ç¶šãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼', 'success');
          
          // ãƒ†ã‚¹ãƒˆç”»åƒã‚’å‰Šé™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          try {
            await fetch(
              `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/destroy`,
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ public_id: data.public_id, upload_preset: cloudinaryConfig.uploadPreset })
              }
            );
          } catch (deleteError) {
            // å‰Šé™¤ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆãƒ†ã‚¹ãƒˆç”»åƒãªã®ã§ï¼‰
            debug('ãƒ†ã‚¹ãƒˆç”»åƒå‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ï¼‰: ' + deleteError.message);
          }
          
          return true;
        } else {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
      } catch (error) {
        debug(`Cloudinaryæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
        toast(`æ¥ç¶šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
        return false;
      } finally {
        btnTestCloudinary.disabled = false;
        btnTestCloudinary.textContent = 'ğŸ§ª æ¥ç¶šãƒ†ã‚¹ãƒˆ';
      }
    }

    async function uploadToCloudinary(file) {
      if (!validateCloudinaryConfig()) {
        throw new Error('Cloudinaryã®è¨­å®šãŒä¸å®Œå…¨ã§ã™ã€‚è¨­å®šç”»é¢ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚');
      }

      debug(`Cloudinaryã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`);

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBã¾ã§ï¼‰
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚(ç¾åœ¨: ${(file.size/1024/1024).toFixed(1)}MB)`);
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
      if (!allowedTypes.includes(file.type)) {
        throw new Error(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™: ${file.type}`);
      }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', cloudinaryConfig.uploadPreset);
      formData.append('folder', `user_photos/${auth.currentUser.uid}`); // ãƒ•ã‚©ãƒ«ãƒ€åˆ†ã‘
      formData.append('resource_type', 'auto'); // è‡ªå‹•æ¤œå‡º
      formData.append('quality', 'auto'); // è‡ªå‹•æœ€é©åŒ–
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 60000); // 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

      try {
        const response = await fetch(
          `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`,
          {
            method: 'POST',
            body: formData,
            signal: controller.signal
          }
        );

        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          const errorMessage = errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`;
          throw new Error(`Cloudinaryã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
        }

        const data = await response.json();
        debug(`Cloudinaryã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${file.name} -> ${data.public_id}`);
        
        return {
          url: data.secure_url,
          publicId: data.public_id,
          width: data.width,
          height: data.height,
          format: data.format,
          bytes: data.bytes,
          // ã‚µãƒ ãƒã‚¤ãƒ«ç”¨URLï¼ˆCloudinaryã®å¤‰æ›æ©Ÿèƒ½ï¼‰
          thumbnailUrl: data.secure_url.replace('/upload/', '/upload/w_300,h_300,c_fill,q_auto/')
        };
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        throw error;
      }
    }

    // ========= ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆGoogleãƒ•ã‚©ãƒˆé¢¨ï¼‰ =========
    function showImageModal(photoIndex) {
      if (!allPhotos || allPhotos.length === 0) return;
      
      currentPhotoIndex = photoIndex;
      const item = allPhotos[currentPhotoIndex];
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      
      const content = document.createElement('div');
      content.className = 'modal-content';
      
      const img = document.createElement('img');
      img.src = item.url;
      img.alt = item.name;
      
      // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³
      const controls = document.createElement('div');
      controls.className = 'modal-controls';
      
      const closeBtn = document.createElement('button');
      closeBtn.className = 'modal-btn';
      closeBtn.innerHTML = 'âœ•';
      closeBtn.onclick = () => closeModal();
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'modal-btn';
      deleteBtn.innerHTML = 'ğŸ—‘ï¸';
      deleteBtn.onclick = () => {
        if (confirm(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
          deletePhoto(item);
          closeModal();
        }
      };
      
      controls.appendChild(closeBtn);
      controls.appendChild(deleteBtn);
      
      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
      const prevBtn = document.createElement('button');
      prevBtn.className = 'modal-nav prev';
      prevBtn.innerHTML = 'â€¹';
      prevBtn.disabled = currentPhotoIndex === 0;
      prevBtn.onclick = () => navigatePhoto(-1);
      
      const nextBtn = document.createElement('button');
      nextBtn.className = 'modal-nav next';
      nextBtn.innerHTML = 'â€º';
      nextBtn.disabled = currentPhotoIndex === allPhotos.length - 1;
      nextBtn.onclick = () => navigatePhoto(1);
      
      // ç”»åƒæƒ…å ±
      const info = document.createElement('div');
      info.className = 'modal-info';
      const sizeText = item.size ? `${(item.size/1024/1024).toFixed(1)}MB` : '';
      const dimensionText = item.width && item.height ? `${item.width}Ã—${item.height}px` : '';
      const indexText = `${currentPhotoIndex + 1} / ${allPhotos.length}`;
      info.innerHTML = `
        <strong>${item.name}</strong><br>
        ${dimensionText} â€¢ ${sizeText} â€¢ ${indexText}
      `;
      
      content.appendChild(img);
      modal.appendChild(content);
      modal.appendChild(controls);
      modal.appendChild(prevBtn);
      modal.appendChild(nextBtn);
      modal.appendChild(info);
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹å‡¦ç†
      function closeModal() {
        if (document.body.contains(modal)) {
          modal.style.animation = 'fadeOut 0.3s ease-out';
          setTimeout(() => {
            if (document.body.contains(modal)) {
              document.body.removeChild(modal);
            }
          }, 300);
        }
      }
      
      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
      function navigatePhoto(direction) {
        const newIndex = currentPhotoIndex + direction;
        if (newIndex >= 0 && newIndex < allPhotos.length) {
          closeModal();
          setTimeout(() => showImageModal(newIndex), 100);
        }
      }
      
      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
      function handleKeyPress(e) {
        switch(e.key) {
          case 'Escape':
            closeModal();
            break;
          case 'ArrowLeft':
            if (!prevBtn.disabled) navigatePhoto(-1);
            break;
          case 'ArrowRight':
            if (!nextBtn.disabled) navigatePhoto(1);
            break;
          case 'Delete':
            if (confirm(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
              deletePhoto(item);
              closeModal();
            }
            break;
        }
      }
      
      document.addEventListener('keydown', handleKeyPress);
      modal.onclick = (e) => {
        if (e.target === modal) closeModal();
      };
      
      // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      const originalCloseModal = closeModal;
      closeModal = () => {
        document.removeEventListener('keydown', handleKeyPress);
        originalCloseModal();
      };
      
      document.body.appendChild(modal);
    }

    // ========= å‰Šé™¤é–¢æ•° =========
    async function deletePhoto(item) {
      try {
        debug(`å‰Šé™¤é–‹å§‹: ${item.name}`);
        
        await db.collection('users').doc(auth.currentUser.uid)
          .collection('photos').doc(item.id).delete();
        
        toast(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
        debug(`å‰Šé™¤å®Œäº†: ${item.name}`);
      } catch(error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        debug(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        toast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // ========= èªè¨¼ UI =========
    btnLogin.addEventListener('click', ()=> {
      debug('ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
      show(authModal);
      hide(settingsSection);
    });
    
    btnLogout.addEventListener('click', async ()=> {
      debug('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–‹å§‹');
      await auth.signOut();
    });

    btnOpenSettings.addEventListener('click', ()=> {
      show(settingsSection);
      hide(authModal);
      validateCloudinaryConfig(); // è¨­å®šç”»é¢ã‚’é–‹ã„ãŸæ™‚ã«çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    });
    
    btnCloseSettings.addEventListener('click', ()=> hide(settingsSection));

    // Cloudinaryè¨­å®šã®å¤‰æ›´ç›£è¦–
    cloudinaryCloudName.addEventListener('input', validateCloudinaryConfig);
    cloudinaryUploadPreset.addEventListener('input', validateCloudinaryConfig);
    
    // Cloudinaryæ¥ç¶šãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
    btnTestCloudinary.addEventListener('click', testCloudinaryConnection);

    authForm.addEventListener('submit', async (e)=> {
      e.preventDefault();
      authError.textContent = '';
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      debug(`ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ: ${email}`);
      
      try{
        await auth.signInWithEmailAndPassword(email, password);
        hide(authModal);
        debug('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ');
        toast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ', 'success');
      }catch(err){ 
        authError.textContent = getFirebaseErrorMessage(err);
        debug(`ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${err.message}`);
      }
    });

    btnRegister.addEventListener('click', async ()=> {
      authError.textContent = '';
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      debug(`æ–°è¦ç™»éŒ²è©¦è¡Œ: ${email}`);
      
      try{
        await auth.createUserWithEmailAndPassword(email, password);
        const uid = auth.currentUser.uid;
        await db.collection('users').doc(uid).set({
          settings: { 
            theme: 'dark',
            cloudinaryCloudName: '',
            cloudinaryUploadPreset: ''
          },
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        hide(authModal);
        debug('æ–°è¦ç™»éŒ²æˆåŠŸ');
        toast('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
      }catch(err){ 
        authError.textContent = getFirebaseErrorMessage(err);
        debug(`æ–°è¦ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${err.message}`);
      }
    });

    btnGoogle.addEventListener('click', async ()=> {
      authError.textContent = '';
      debug('Googleèªè¨¼é–‹å§‹');
      
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        hide(authModal);
        debug('Googleèªè¨¼æˆåŠŸ');
        toast('Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ', 'success');
      }catch(err){ 
        authError.textContent = getFirebaseErrorMessage(err);
        debug(`Googleèªè¨¼ã‚¨ãƒ©ãƒ¼: ${err.message}`);
      }
    });

    // Firebase ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ—¥æœ¬èªåŒ–
    function getFirebaseErrorMessage(error) {
      switch (error.code) {
        case 'auth/user-not-found':
          return 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ–°è¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚';
        case 'auth/wrong-password':
          return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚';
        case 'auth/email-already-in-use':
          return 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
        case 'auth/weak-password':
          return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚';
        case 'auth/invalid-email':
          return 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        case 'auth/network-request-failed':
          return 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        case 'auth/popup-closed-by-user':
          return 'ãƒ­ã‚°ã‚¤ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚';
        default:
          return error.message;
      }
    }

    // ========= çŠ¶æ…‹ç›£è¦– =========
    let unsubPhotos = null;
    auth.onAuthStateChanged(async (user)=> {
      if(user){
        debug(`èªè¨¼çŠ¶æ…‹å¤‰æ›´: ãƒ­ã‚°ã‚¤ãƒ³ ${user.email || user.uid}`);
        authState.textContent = `${user.email || user.displayName || user.uid}`;
        hide(btnLogin); show(btnLogout); show(appSection); hide(authModal);

        // è¨­å®šèª­è¾¼
        try {
          const userDoc = await db.collection('users').doc(user.uid).get();
          const settings = userDoc.exists && userDoc.data().settings ? userDoc.data().settings : { 
            theme:'dark',
            cloudinaryCloudName: '',
            cloudinaryUploadPreset: ''
          };
          
          // ãƒ†ãƒ¼ãƒé©ç”¨
          applyTheme(settings.theme || 'dark');
          themeSelect.value = settings.theme || 'dark';
          
          // Cloudinaryè¨­å®šèª­ã¿è¾¼ã¿
          cloudinaryConfig.cloudName = settings.cloudinaryCloudName || '';
          cloudinaryConfig.uploadPreset = settings.cloudinaryUploadPreset || '';
          cloudinaryCloudName.value = cloudinaryConfig.cloudName;
          cloudinaryUploadPreset.value = cloudinaryConfig.uploadPreset;
          
          // è¨­å®šçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
          validateCloudinaryConfig();
          
          debug('è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†');
        } catch (error) {
          debug(`è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }

        // å†™çœŸä¸€è¦§ã‚’è³¼èª­
        subscribePhotos('createdAt_desc');
      } else {
        debug('èªè¨¼çŠ¶æ…‹å¤‰æ›´: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ');
        authState.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
        show(btnLogin); hide(btnLogout); hide(appSection); hide(settingsSection);
        photoGrid.innerHTML = ''; photoCount.textContent = '0'; show(emptyState);
        allPhotos = []; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
        hide(statusAlert); // è­¦å‘Šéè¡¨ç¤º
        if(unsubPhotos){ unsubPhotos(); unsubPhotos = null; }
      }
    });

    // ========= è¨­å®šä¿å­˜ =========
    btnSaveSettings.addEventListener('click', async ()=> {
      const user = auth.currentUser; if(!user) return;
      
      const next = { 
        theme: themeSelect.value,
        cloudinaryCloudName: cloudinaryCloudName.value.trim(),
        cloudinaryUploadPreset: cloudinaryUploadPreset.value.trim()
      };
      
      try {
        await db.collection('users').doc(user.uid).set({ settings: next }, { merge:true });
        
        // Cloudinaryè¨­å®šã‚’æ›´æ–°
        cloudinaryConfig.cloudName = next.cloudinaryCloudName;
        cloudinaryConfig.uploadPreset = next.cloudinaryUploadPreset;
        
        // è¨­å®šçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        validateCloudinaryConfig();
        
        applyTheme(next.theme);
        toast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        hide(settingsSection);
        debug('è¨­å®šä¿å­˜å®Œäº†');
      } catch (error) {
        debug(`è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        toast('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    });

    function applyTheme(mode){
      if(mode==='light'){
        document.documentElement.style.setProperty('--bg','#f6f7fb');
        document.documentElement.style.setProperty('--card','#ffffff');
        document.documentElement.style.setProperty('--text','#0d1117');
        document.documentElement.style.setProperty('--muted','#516079');
        document.documentElement.style.setProperty('--acc','#2563eb');
      } else {
        document.documentElement.style.setProperty('--bg','#0f1115');
        document.documentElement.style.setProperty('--card','#151821');
        document.documentElement.style.setProperty('--text','#e9edf1');
        document.documentElement.style.setProperty('--muted','#aab2c0');
        document.documentElement.style.setProperty('--acc','#4ea1ff');
      }
    }

    // ========= å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ =========
    let selectedFiles = [];
    fileInput.addEventListener('change', ()=> {
      selectedFiles = Array.from(fileInput.files || []).slice(0,10);
      updateUploadButton();
      debug(`ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ: ${selectedFiles.length}ä»¶`);
    });

    function updateUploadButton() {
      const hasFiles = selectedFiles.length > 0;
      const hasConfig = validateCloudinaryConfig();
      
      btnUpload.disabled = !hasFiles || !hasConfig;
      
      if (selectedFiles.length > 0) {
        document.getElementById('uploadHint').textContent = `${selectedFiles.length} ä»¶é¸æŠä¸­`;
        if (!hasConfig) {
          document.getElementById('uploadHint').textContent += ' (è¨­å®šãŒå¿…è¦)';
        }
      } else {
        document.getElementById('uploadHint').textContent = 'æœ€å¤§10æšã¾ã§åŒæ™‚ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™';
      }
    }

    btnUpload.addEventListener('click', async ()=> {
      const user = auth.currentUser; 
      if(!user || selectedFiles.length===0) return;
      
      // è¨­å®šãƒã‚§ãƒƒã‚¯
      if (!validateCloudinaryConfig()) {
        toast('Cloudinaryã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚è¨­å®šç”»é¢ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
        show(settingsSection);
        return;
      }
      
      debug(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${selectedFiles.length}ä»¶`);
      
      try {
        show(progressBox); 
        progressBar.style.width = '0%';
        btnUpload.disabled = true;
        btnUpload.textContent = 'â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

        let completed = 0;
        let failed = 0;
        const total = selectedFiles.length;
        const results = [];

        for(let i = 0; i < selectedFiles.length; i++){
          const file = selectedFiles[i];
          debug(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ ${i+1}/${total}: ${file.name}`);
          
          try {
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ï¼‰
            const baseProgress = (i / total) * 100;
            progressBar.style.width = `${baseProgress}%`;
            
            // Cloudinaryã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            const cloudinaryResult = await uploadToCloudinary(file);
            debug(`Cloudinaryã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${file.name}`);
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°ï¼ˆCloudinaryå®Œäº†ï¼‰
            progressBar.style.width = `${baseProgress + 25}%`;
            
            // Firestoreã«ä¿å­˜
            const docData = {
              name: file.name,
              url: cloudinaryResult.url,
              thumbnailUrl: cloudinaryResult.thumbnailUrl,
              cloudinaryPublicId: cloudinaryResult.publicId,
              size: file.size,
              type: file.type,
              width: cloudinaryResult.width,
              height: cloudinaryResult.height,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              uploadedAt: new Date()
            };
            
            const docRef = await db.collection('users').doc(user.uid)
              .collection('photos').add(docData);
            
            debug(`Firestoreä¿å­˜å®Œäº†: ${docRef.id} - ${file.name}`);
            results.push({ success: true, fileName: file.name });
            completed++;
            
          } catch (fileError) {
            debug(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ ${file.name}: ${fileError.message}`);
            results.push({ success: false, fileName: file.name, error: fileError.message });
            failed++;
          }
          
          const totalProgress = ((i + 1) / total) * 100;
          progressBar.style.width = `${totalProgress}%`;
        }

        await sleep(500);
        debug(`å…¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: æˆåŠŸ${completed}ä»¶, å¤±æ•—${failed}ä»¶`);
        
        // çµæœã®é€šçŸ¥
        if (completed > 0 && failed === 0) {
          toast(`${completed}ä»¶ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼`, 'success');
        } else if (completed > 0 && failed > 0) {
          toast(`${completed}ä»¶æˆåŠŸã€${failed}ä»¶å¤±æ•—ã—ã¾ã—ãŸã€‚`, 'warning');
        } else {
          toast(`ã™ã¹ã¦ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`, 'error');
        }
        
        // å¤±æ•—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯è©³ç´°ã‚’è¡¨ç¤º
        if (failed > 0) {
          const failedFiles = results.filter(r => !r.success);
          console.warn('å¤±æ•—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«:', failedFiles);
        }
        
      } catch(error) {
        console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        debug(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${error.message}`);
        toast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      } finally {
        hide(progressBox); 
        progressBar.style.width = '0%';
        btnUpload.disabled = false;
        btnUpload.textContent = 'â¬†ï¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
        selectedFiles = []; 
        fileInput.value = '';
        updateUploadButton();
      }
    });

    // ========= å†™çœŸä¸€è¦§è³¼èª­ =========
    function subscribePhotos(sortKey){
      const user = auth.currentUser; 
      if(!user) {
        debug('å†™çœŸè³¼èª­: ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªãƒ­ã‚°ã‚¤ãƒ³');
        return;
      }

      if(unsubPhotos){ 
        debug('æ—¢å­˜ã®å†™çœŸè³¼èª­ã‚’è§£é™¤');
        unsubPhotos(); 
        unsubPhotos = null; 
      }

      debug(`å†™çœŸè³¼èª­é–‹å§‹: ${sortKey}`);
      show(loadingState);
      hide(emptyState);

      let q = db.collection('users').doc(user.uid).collection('photos');
      
      if(sortKey === 'createdAt_asc') {
        q = q.orderBy('createdAt','asc');
      } else if(sortKey === 'name_asc') {
        q = q.orderBy('name','asc');
      } else if(sortKey === 'name_desc') {
        q = q.orderBy('name','desc');
      } else {
        q = q.orderBy('createdAt','desc');
      }

      unsubPhotos = q.onSnapshot((snap)=> {
        debug(`å†™çœŸãƒ‡ãƒ¼ã‚¿å—ä¿¡: ${snap.size}ä»¶`);
        const items = [];
        snap.forEach(doc=> {
          const data = doc.data();
          items.push({ id: doc.id, ...data });
        });
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
        allPhotos = items;
        
        hide(loadingState);
        renderPhotos(items);
        
        // åˆå›ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ™‚ã®é€šçŸ¥
        if (snap.size > 0) {
          debug(`å†™çœŸã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ: ${snap.size}ä»¶`);
        }
      }, (error) => {
        hide(loadingState);
        debug(`å†™çœŸè³¼èª­ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        console.error('å†™çœŸè³¼èª­ã‚¨ãƒ©ãƒ¼:', error);
        toast('å†™çœŸã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      });
    }

    sortSelect.addEventListener('change', ()=> {
      debug(`ã‚½ãƒ¼ãƒˆå¤‰æ›´: ${sortSelect.value}`);
      subscribePhotos(sortSelect.value);
    });
    
    searchInput.addEventListener('input', ()=> {
      debug(`æ¤œç´¢: ${searchInput.value}`);
      renderPhotos(allPhotos); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å†æç”»
    });

    function renderPhotos(items){
      debug(`å†™çœŸæç”»é–‹å§‹: ${items.length}ä»¶`);
      
      const q = (searchInput.value || '').toLowerCase().trim();
      const filtered = q ? items.filter(it=> (it.name||'').toLowerCase().includes(q)) : items;

      photoCount.textContent = String(filtered.length);
      
      if(filtered.length === 0){
        photoGrid.innerHTML = '';
        show(emptyState);
        debug('å†™çœŸãªã— - ç©ºçŠ¶æ…‹è¡¨ç¤º');
        return;
      }
      
      hide(emptyState);

      photoGrid.innerHTML = '';
      filtered.forEach((item, index)=>{
        const div = document.createElement('div');
        div.className = 'card';
        div.title = item.name;
        
        // ç”»åƒï¼ˆã‚µãƒ ãƒã‚¤ãƒ«å„ªå…ˆã€ãªã‘ã‚Œã°ã‚ªãƒªã‚¸ãƒŠãƒ«ï¼‰
        const img = document.createElement('img');
        img.src = item.thumbnailUrl || item.url;
        img.alt = item.name || 'photo';
        img.loading = 'lazy';
        
        // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼å¯¾å¿œ
        img.onerror = () => {
          if (img.src !== item.url) {
            debug(`ã‚µãƒ ãƒã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—ã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ${item.name}`);
            img.src = item.url;
          } else {
            debug(`ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—: ${item.name}`);
            img.alt = 'ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“';
          }
        };
        
        // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤º
        img.onclick = () => {
          const originalIndex = allPhotos.findIndex(p => p.id === item.id);
          showImageModal(originalIndex);
        };
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.innerHTML = 'ğŸ—‘ï¸';
        delBtn.title = 'å‰Šé™¤';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            deletePhoto(item);
          }
        };
        
        // ç”»åƒæƒ…å ±ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
        const info = document.createElement('div');
        info.className = 'card-info';
        const sizeInMB = item.size ? (item.size/1024/1024).toFixed(1) : '0.0';
        const dimensions = item.width && item.height ? ` â€¢ ${item.width}Ã—${item.height}` : '';
        info.innerHTML = `
          <div class="card-name" title="${item.name}">${item.name || 'unknown'}</div>
          <div>${sizeInMB}MB${dimensions}</div>
        `;
        
        div.appendChild(img);
        div.appendChild(delBtn);
        div.appendChild(info);
        photoGrid.appendChild(div);
      });
      
      debug(`å†™çœŸæç”»å®Œäº†: ${filtered.length}ä»¶è¡¨ç¤º`);
    }

    // åˆæœŸåŒ–å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    window.addEventListener('load', () => {
      debug('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†');
    });

    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('error', (e) => {
      debug(`ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${e.error?.message || e.message}`);
      console.error('ã‚¨ãƒ©ãƒ¼:', e);
    });

    window.addEventListener('unhandledrejection', (e) => {
      debug(`Promiseæ‹’å¦: ${e.reason?.message || e.reason}`);
      console.error('Promiseæ‹’å¦:', e);
      e.preventDefault(); // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¸ã®å‡ºåŠ›ã‚’æŠ‘åˆ¶
    });
  </script>
</body>
</html>
