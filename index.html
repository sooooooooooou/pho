<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Startpage Â· Firebase Sync (Photos + Settings)</title>
  <style>
    :root{--bg:#0f1115;--card:#151821;--muted:#aab2c0;--text:#e9edf1;--acc:#4ea1ff;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:14px 16px;background:#0c0e12;border-bottom:1px solid #1e2230;position:sticky;top:0;z-index:100}
    .btn{appearance:none;border:1px solid #2a3040;background:#1a1f2b;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-size:14px}
    .btn:hover{border-color:#3b4256}
    .btn.primary{background:var(--acc);color:white;border-color:transparent}
    .btn.success{background:#22c55e;color:white;border-color:transparent}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid #1f2432;border-radius:14px;overflow:hidden;position:relative;transition:transform 0.2s}
    .card:hover{transform:translateY(-2px)}
    .card > img{width:100%;height:200px;object-fit:cover;display:block;background:#0b0d11;cursor:pointer;transition:opacity 0.2s}
    .card > img:hover{opacity:0.8}
    .row{display:flex;gap:8px;align-items:center}
    .stack{display:flex;flex-direction:column;gap:10px}
    .muted{color:var(--muted)}
    .hidden{display:none!important}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    input, select, textarea{background:#161a24;color:var(--text);border:1px solid #2a3040;border-radius:10px;padding:9px 12px;outline:none;width:100%}
    input[type="file"]{padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:16px}
    .chip{font-size:12px;padding:4px 8px;border:1px solid #2a3040;border-radius:999px;color:var(--muted);background:var(--card)}
    .tag{font-size:11px;padding:2px 6px;border:1px solid var(--acc);border-radius:999px;color:var(--acc);background:rgba(78,161,255,0.1);margin:2px}
    .danger{color:#ff647c}
    .success{color:#22c55e}
    .progress{height:8px;background:#12151d;border:1px solid #23293a;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;width:0;background:var(--acc);transition:width .2s linear}
    .center{display:flex;align-items:center;justify-content:center}
    .folder-nav{display:flex;gap:4px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .folder-btn{background:var(--card);border:1px solid #2a3040;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:12px}
    .folder-btn.active{background:var(--acc);color:white;border-color:transparent}
    
    /* å‰Šé™¤ãƒœã‚¿ãƒ³ */
    .delete-btn{
      position:absolute;
      top:8px;
      right:8px;
      background:rgba(255,100,124,0.9);
      color:white;
      border:none;
      border-radius:50%;
      width:28px;
      height:28px;
      cursor:pointer;
      font-size:14px;
      line-height:1;
      opacity:0;
      transition:opacity 0.2s;
    }
    .card:hover .delete-btn{opacity:1}
    .delete-btn:hover{background:rgba(255,100,124,1)}
    
    /* é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
    .select-checkbox{
      position:absolute;
      top:8px;
      left:8px;
      width:20px;
      height:20px;
      opacity:0;
      transition:opacity 0.2s;
    }
    .card:hover .select-checkbox{opacity:1}
    
    /* ç·¨é›†ãƒœã‚¿ãƒ³ */
    .edit-btn{
      position:absolute;
      top:8px;
      right:42px;
      background:rgba(78,161,255,0.9);
      color:white;
      border:none;
      border-radius:50%;
      width:28px;
      height:28px;
      cursor:pointer;
      font-size:12px;
      line-height:1;
      opacity:0;
      transition:opacity 0.2s;
    }
    .card:hover .edit-btn{opacity:1}
    .edit-btn:hover{background:rgba(78,161,255,1)}
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal{
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      background:rgba(0,0,0,0.9);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      cursor:pointer;
    }
    .modal img{
      max-width:90%;
      max-height:90%;
      object-fit:contain;
      border-radius:8px;
    }
    .modal-info{
      position:absolute;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.8);
      color:white;
      padding:8px 16px;
      border-radius:20px;
      font-size:12px;
      max-width:80%;
      text-align:center;
    }
    
    /* ç”»åƒæƒ…å ± */
    .card-info{
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      background:linear-gradient(transparent, rgba(0,0,0,0.8));
      color:white;
      padding:12px 10px 8px;
      font-size:11px;
      line-height:1.3;
    }
    .card-name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin-bottom:4px;
      font-weight:500;
    }
    .card-tags{
      display:flex;
      flex-wrap:wrap;
      gap:2px;
      margin-top:4px;
    }
    .card-folder{
      font-size:10px;
      opacity:0.8;
    }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .form-modal{
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      background:rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .form-modal-content{
      background:var(--card);
      border:1px solid #2a3040;
      border-radius:12px;
      padding:20px;
      max-width:500px;
      width:90%;
      max-height:80vh;
      overflow-y:auto;
    }
    
    /* ç”»åƒç·¨é›†ã‚­ãƒ£ãƒ³ãƒã‚¹ */
    .canvas-container{
      position:relative;
      max-width:100%;
      margin:10px 0;
    }
    .edit-controls{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(100px,1fr));
      gap:8px;
      margin:10px 0;
    }
    
    /* ä¸€æ‹¬é¸æŠãƒãƒ¼ */
    .bulk-actions{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:var(--card);
      border:1px solid #2a3040;
      border-radius:12px;
      padding:12px 16px;
      display:none;
      gap:8px;
      align-items:center;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
      z-index:1000;
    }
    .bulk-actions.show{display:flex}
  </style>
</head>
<body>
  <header>
    <div class="row" style="gap:12px">
      <strong>Photo Manager</strong>
      <span id="authState" class="chip">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
    </div>
    <div class="row" style="gap:8px">
      <button id="btnOpenSettings" class="btn ghost">è¨­å®š</button>
      <button id="btnLogin" class="btn primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button id="btnLogout" class="btn hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <main class="wrap stack">
    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ / ä¸€è¦§ -->
    <section id="appSection" class="stack hidden">
      <div class="toolbar">
        <button id="btnSelectFiles" class="btn primary">+ ç”»åƒã‚’è¿½åŠ </button>
        <button id="btnUpload" class="btn success" disabled>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <button id="btnCreateFolder" class="btn ghost">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</button>
        <span id="uploadHint" class="muted">æœ€å¤§10æšã¾ã§åŒæ™‚ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</span>
        <input id="fileInput" type="file" accept="image/*" multiple hidden>
      </div>
      
      <!-- é€²è¡ŒçŠ¶æ³ -->
      <div id="progressBox" class="progress hidden"><div id="progressBar"></div></div>

      <!-- ãƒ•ã‚©ãƒ«ãƒ€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div id="folderNav" class="folder-nav">
        <button class="folder-btn active" data-folder="">ã™ã¹ã¦</button>
      </div>

      <!-- æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆ -->
      <div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:8px">
        <div class="row" style="gap:10px">
          <span class="muted">åˆè¨ˆ:</span>
          <strong id="photoCount">0</strong>
          <span id="selectedCount" class="muted hidden"></span>
        </div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <select id="sortSelect">
            <option value="createdAt_desc">æ–°ã—ã„é †</option>
            <option value="createdAt_asc">å¤ã„é †</option>
            <option value="name_asc">åå‰ Aâ†’Z</option>
            <option value="name_desc">åå‰ Zâ†’A</option>
          </select>
          <input id="searchInput" placeholder="åå‰ãƒ»ã‚¿ã‚°ã§æ¤œç´¢" style="min-width:200px" />
          <button id="btnBulkDownload" class="btn ghost">ä¸€æ‹¬DL</button>
        </div>
      </div>

      <div id="photoGrid" class="grid"></div>
      <div id="emptyState" class="center muted" style="padding:40px">ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ã€Œ+ ç”»åƒã‚’è¿½åŠ ã€ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã­ã€‚</div>
    </section>

    <!-- è¨­å®š -->
    <section id="settingsSection" class="card hidden" style="padding:16px">
      <h3 style="margin:0 0 10px">è¨­å®š</h3>
      <div class="stack">
        <label class="row" style="justify-content:space-between"><span>ãƒ†ãƒ¼ãƒ</span>
          <select id="themeSelect" style="width:180px">
            <option value="dark">ãƒ€ãƒ¼ã‚¯</option>
            <option value="light">ãƒ©ã‚¤ãƒˆ</option>
          </select>
        </label>
        <div class="row" style="gap:8px;justify-content:flex-end">
          <button id="btnCloseSettings" class="btn ghost">é–‰ã˜ã‚‹</button>
          <button id="btnSaveSettings" class="btn primary">ä¿å­˜</button>
        </div>
      </div>
    </section>

    <!-- èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <section id="authModal" class="card hidden" style="padding:16px;max-width:460px;margin:0 auto">
      <h3 style="margin:0 0 6px">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h3>
      <p class="muted" style="margin:0 0 12px">ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚åˆã‚ã¦ãªã‚‰ãã®ã¾ã¾ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
      <form id="authForm" class="stack">
        <input id="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹: you@example.comï¼‰" required />
        <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰" minlength="6" required />
        <div class="row" style="justify-content:space-between">
          <button type="submit" class="btn primary" id="btnEmailLogin">ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button type="button" class="btn" id="btnRegister">æ–°è¦ç™»éŒ²</button>
        </div>
        <div class="row" style="gap:8px;align-items:center;justify-content:center"><span class="muted">ã¾ãŸã¯</span></div>
        <button type="button" class="btn" id="btnGoogle">Googleã§ç¶šè¡Œ</button>
      </form>
      <p id="authError" class="danger" style="min-height:1.2em"></p>
    </section>

  </main>

  <!-- ä¸€æ‹¬æ“ä½œãƒãƒ¼ -->
  <div id="bulkActions" class="bulk-actions">
    <span id="bulkCount">0ä»¶é¸æŠä¸­</span>
    <button id="btnBulkDelete" class="btn danger">å‰Šé™¤</button>
    <button id="btnBulkMove" class="btn">ç§»å‹•</button>
    <button id="btnBulkTag" class="btn">ã‚¿ã‚°ç·¨é›†</button>
    <button id="btnClearSelection" class="btn ghost">é¸æŠè§£é™¤</button>
  </div>

  <!-- ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="folderModal" class="form-modal hidden">
    <div class="form-modal-content">
      <h3 style="margin:0 0 16px">ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</h3>
      <input id="folderNameInput" placeholder="ãƒ•ã‚©ãƒ«ãƒ€å" />
      <div class="row" style="gap:8px;justify-content:flex-end;margin-top:16px">
        <button id="btnCancelFolder" class="btn ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="btnCreateFolderConfirm" class="btn primary">ä½œæˆ</button>
      </div>
    </div>
  </div>

  <!-- ç”»åƒç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editModal" class="form-modal hidden">
    <div class="form-modal-content">
      <h3 style="margin:0 0 16px">ç”»åƒç·¨é›†</h3>
      <div class="stack">
        <input id="editName" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«å" />
        <select id="editFolder">
          <option value="">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</option>
        </select>
        <input id="editTags" placeholder="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ä¾‹: é¢¨æ™¯,æ—…è¡Œ,å¤" />
        
        <!-- ç°¡æ˜“ç”»åƒç·¨é›† -->
        <div class="canvas-container">
          <canvas id="editCanvas" style="max-width:100%;border:1px solid #2a3040;border-radius:8px"></canvas>
        </div>
        
        <div class="edit-controls">
          <button id="btnRotate" class="btn">å›è»¢</button>
          <button id="btnFlipH" class="btn">å·¦å³åè»¢</button>
          <button id="btnFlipV" class="btn">ä¸Šä¸‹åè»¢</button>
          <button id="btnReset" class="btn ghost">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        
        <div class="row">
          <label style="flex:1">æ˜åº¦: <input id="brightness" type="range" min="0" max="200" value="100"></label>
          <label style="flex:1">ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ: <input id="contrast" type="range" min="0" max="200" value="100"></label>
        </div>
        
        <div class="row" style="gap:8px;justify-content:flex-end;margin-top:16px">
          <button id="btnCancelEdit" class="btn ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="btnSaveEdit" class="btn success">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <script>
    // === Firebase è¨­å®š ===
    const firebaseConfig = {
      apiKey: "AIzaSyBCkkQGoq6xm9gIi3SXD5ACWyF09_cXo4A",
      authDomain: "phote-ec8f0.firebaseapp.com",
      projectId: "phote-ec8f0",
      storageBucket: "phote-ec8f0.appspot.com",
      messagingSenderId: "325922770311",
      appId: "1:325922770311:web:a39493565961d7ae861722"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ========= DOM å‚ç…§ =========
    const authState = document.getElementById('authState');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const appSection = document.getElementById('appSection');
    const authModal = document.getElementById('authModal');
    const authForm = document.getElementById('authForm');
    const btnRegister = document.getElementById('btnRegister');
    const btnGoogle = document.getElementById('btnGoogle');
    const authError = document.getElementById('authError');

    const fileInput = document.getElementById('fileInput');
    const btnSelectFiles = document.getElementById('btnSelectFiles');
    const btnUpload = document.getElementById('btnUpload');
    const progressBox = document.getElementById('progressBox');
    const progressBar = document.getElementById('progressBar');
    const photoGrid = document.getElementById('photoGrid');
    const emptyState = document.getElementById('emptyState');
    const photoCount = document.getElementById('photoCount');

    const sortSelect = document.getElementById('sortSelect');
    const searchInput = document.getElementById('searchInput');

    const settingsSection = document.getElementById('settingsSection');
    const btnOpenSettings = document.getElementById('btnOpenSettings');
    const btnCloseSettings = document.getElementById('btnCloseSettings');
    const btnSaveSettings = document.getElementById('btnSaveSettings');
    const themeSelect = document.getElementById('themeSelect');

    // ãƒ•ã‚©ãƒ«ãƒ€é–¢é€£
    const folderNav = document.getElementById('folderNav');
    const btnCreateFolder = document.getElementById('btnCreateFolder');
    const folderModal = document.getElementById('folderModal');
    const folderNameInput = document.getElementById('folderNameInput');
    const btnCancelFolder = document.getElementById('btnCancelFolder');
    const btnCreateFolderConfirm = document.getElementById('btnCreateFolderConfirm');

    // ç·¨é›†é–¢é€£
    const editModal = document.getElementById('editModal');
    const editName = document.getElementById('editName');
    const editFolder = document.getElementById('editFolder');
    const editTags = document.getElementById('editTags');
    const editCanvas = document.getElementById('editCanvas');
    const btnCancelEdit = document.getElementById('btnCancelEdit');
    const btnSaveEdit = document.getElementById('btnSaveEdit');

    // ä¸€æ‹¬æ“ä½œ
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    const bulkCount = document.getElementById('bulkCount');
    const btnBulkDownload = document.getElementById('btnBulkDownload');
    const btnClearSelection = document.getElementById('btnClearSelection');

    // ========= ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =========
    let selectedFiles = [];
    let currentFolder = '';
    let folders = [];
    let selectedPhotos = new Set();
    let currentEditItem = null;
    let originalImageData = null;
    let unsubPhotos = null;

    // ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =========
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    const show = (el)=> el.classList.remove('hidden');
    const hide = (el)=> el.classList.add('hidden');

    function toast(msg, type = 'info'){
      console.log(msg);
      const toast = document.createElement('div');
      toast.textContent = msg;
      const colors = {
        info: '#4ea1ff',
        success: '#22c55e',
        error: '#ff647c'
      };
      toast.style.cssText = `position:fixed;top:20px;right:20px;background:${colors[type] || colors.info};color:white;padding:8px 16px;border-radius:8px;z-index:10000;`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ========= èªè¨¼å‡¦ç† =========
    btnLogin.addEventListener('click', ()=> show(authModal));
    btnLogout.addEventListener('click', async ()=> {
      await auth.signOut();
    });

    btnOpenSettings.addEventListener('click', ()=> show(settingsSection));
    btnCloseSettings.addEventListener('click', ()=> hide(settingsSection));

    authForm.addEventListener('submit', async (e)=> {
      e.preventDefault();
      authError.textContent = '';
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      try{
        await auth.signInWithEmailAndPassword(email, password);
        hide(authModal);
      }catch(err){ authError.textContent = err.message; }
    });

    btnRegister.addEventListener('click', async ()=> {
      authError.textContent = '';
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      try{
        await auth.createUserWithEmailAndPassword(email, password);
        const uid = auth.currentUser.uid;
        await db.collection('users').doc(uid).set({
          settings: { theme:'dark' },
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        hide(authModal);
      }catch(err){ authError.textContent = err.message; }
    });

    btnGoogle.addEventListener('click', async ()=> {
      authError.textContent = '';
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        hide(authModal);
      }catch(err){ authError.textContent = err.message; }
    });

    // ========= çŠ¶æ…‹ç›£è¦– =========
    auth.onAuthStateChanged(async (user)=> {
      if(user){
        authState.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.email || user.displayName || user.uid}`;
        hide(btnLogin); show(btnLogout); show(appSection);

        // è¨­å®šèª­è¾¼
        try {
          const userDoc = await db.collection('users').doc(user.uid).get();
          const settings = userDoc.exists && userDoc.data().settings ? userDoc.data().settings : { theme:'dark' };
          applyTheme(settings.theme || 'dark');
          themeSelect.value = settings.theme || 'dark';
        } catch(e) {
          console.log('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        }

        // ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã¨ãƒ•ã‚©ãƒˆè³¼èª­
        await loadFolders();
        subscribePhotos();
      } else {
        authState.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
        show(btnLogin); hide(btnLogout); hide(appSection); hide(settingsSection);
        photoGrid.innerHTML = ''; photoCount.textContent = '0'; show(emptyState);
        if(unsubPhotos){ unsubPhotos(); unsubPhotos = null; }
      }
    });

    // ========= è¨­å®šä¿å­˜ =========
    btnSaveSettings.addEventListener('click', async ()=> {
      const user = auth.currentUser; if(!user) return;
      try {
        const next = { theme: themeSelect.value };
        await db.collection('users').doc(user.uid).set({ settings: next }, { merge:true });
        applyTheme(next.theme);
        toast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        hide(settingsSection);
      } catch(e) {
        toast('è¨­å®šä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    });

    function applyTheme(mode){
      if(mode==='light'){
        document.documentElement.style.setProperty('--bg','#f6f7fb');
        document.documentElement.style.setProperty('--card','#ffffff');
        document.documentElement.style.setProperty('--text','#0d1117');
        document.documentElement.style.setProperty('--muted','#516079');
        document.documentElement.style.setProperty('--acc','#2563eb');
      } else {
        document.documentElement.style.setProperty('--bg','#0f1115');
        document.documentElement.style.setProperty('--card','#151821');
        document.documentElement.style.setProperty('--text','#e9edf1');
        document.documentElement.style.setProperty('--muted','#aab2c0');
        document.documentElement.style.setProperty('--acc','#4ea1ff');
      }
    }

    // ========= ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ =========
    btnSelectFiles.addEventListener('click', ()=> {
      fileInput.click();
    });
    
    fileInput.addEventListener('change', ()=> {
      selectedFiles = Array.from(fileInput.files || []).slice(0,10);
      btnUpload.disabled = selectedFiles.length===0;
      document.getElementById('uploadHint').textContent = selectedFiles.length ? `${selectedFiles.length} ä»¶é¸æŠä¸­` : 'æœ€å¤§10æšã¾ã§åŒæ™‚ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™';
    });

    btnUpload.addEventListener('click', async ()=> {
      const user = auth.currentUser; 
      if(!user || selectedFiles.length===0) return;
      
      try {
        show(progressBox); 
        progressBar.style.width = '0%';
        btnUpload.disabled = true;

        let completed = 0;
        for(const file of selectedFiles){
          const ext = file.name.split('.').pop();
          const path = `users/${user.uid}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
          const ref = storage.ref(path);
          const task = ref.put(file, { contentType: file.type });
          
          await new Promise((resolve, reject)=> {
            task.on('state_changed', (snap)=> {
              const p = ((completed + snap.bytesTransferred / snap.totalBytes) / selectedFiles.length) * 100;
              progressBar.style.width = `${Math.min(100, p)}%`;
            }, reject, async ()=> {
              try{
                const url = await ref.getDownloadURL();
                await db.collection('users').doc(user.uid)
                  .collection('photos').add({
                    name: file.name,
                    url,
                    storagePath: path,
                    size: file.size,
                    type: file.type,
                    folder: currentFolder,
                    tags: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                  });
                completed++;
                progressBar.style.width = `${Math.min(100, (completed/selectedFiles.length)*100)}%`;
                resolve();
              }catch(err){ reject(err); }
            });
          });
        }

        await sleep(250);
        toast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼', 'success');
        
      } catch(error) {
        console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        toast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      } finally {
        hide(progressBox); 
        progressBar.style.width = '0%';
        btnUpload.disabled = false;
        selectedFiles = []; 
        fileInput.value = '';
        document.getElementById('uploadHint').textContent = 'æœ€å¤§10æšã¾ã§åŒæ™‚ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™';
      }
    });

    // ========= ãƒ•ã‚©ãƒ«ãƒ€ç®¡ç† =========
    btnCreateFolder.addEventListener('click', ()=> show(folderModal));
    btnCancelFolder.addEventListener('click', ()=> hide(folderModal));

    btnCreateFolderConfirm.addEventListener('click', async ()=> {
      const user = auth.currentUser;
      const name = folderNameInput.value.trim();
      if(!user || !name) return;

      try {
        await db.collection('users').doc(user.uid).collection('folders').add({
          name,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        folderNameInput.value = '';
        hide(folderModal);
        toast('ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
        await loadFolders();
      } catch(e) {
        toast('ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    });

    async function loadFolders() {
      const user = auth.currentUser;
      if(!user) return;
      
      try {
        const snap = await db.collection('users').doc(user.uid).collection('folders').orderBy('name').get();
        folders = [];
        snap.forEach(doc => folders.push({ id: doc.id, ...doc.data() }));
        renderFolderNav();
        updateEditFolderOptions();
      } catch(e) {
        console.log('ãƒ•ã‚©ãƒ«ãƒ€èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function renderFolderNav() {
      folderNav.innerHTML = '<button class="folder-btn active" data-folder="">ã™ã¹ã¦</button>';
      folders.forEach(folder => {
        const btn = document.createElement('button');
        btn.className = 'folder-btn';
        btn.dataset.folder = folder.id;
        btn.textContent = folder.name;
        btn.onclick = () => selectFolder(folder.id);
        folderNav.appendChild(btn);
      });
    }

    function selectFolder(folderId) {
      currentFolder = folderId;
      document.querySelectorAll('.folder-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.folder === folderId);
      });
      subscribePhotos();
    }

    function updateEditFolderOptions() {
      editFolder.innerHTML = '<option value="">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</option>';
      folders.forEach(folder => {
        const option = document.createElement('option');
        option.value = folder.id;
        option.textContent = folder.name;
        editFolder.appendChild(option);
      });
    }

    // ãƒ•ã‚©ãƒ«ãƒ€ãƒŠãƒ“ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    folderNav.addEventListener('click', (e) => {
      if(e.target.classList.contains('folder-btn')) {
        selectFolder(e.target.dataset.folder);
      }
    });

    // ========= å†™çœŸä¸€è¦§è³¼èª­ =========
    function subscribePhotos(){
      const user = auth.currentUser; if(!user) return;
      if(unsubPhotos){ unsubPhotos(); unsubPhotos = null; }

      let q = db.collection('users').doc(user.uid).collection('photos');
      
      // ãƒ•ã‚©ãƒ«ãƒ€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if(currentFolder) {
        q = q.where('folder', '==', currentFolder);
      }
      
      // ã‚½ãƒ¼ãƒˆ
      const sortKey = sortSelect.value;
      if(sortKey === 'createdAt_asc') q = q.orderBy('createdAt','asc');
      else if(sortKey === 'name_asc') q = q.orderBy('name','asc');
      else if(sortKey === 'name_desc') q = q.orderBy('name','desc');
      else q = q.orderBy('createdAt','desc');

      unsubPhotos = q.onSnapshot((snap)=> {
        const items = [];
        snap.forEach(doc=> items.push({ id: doc.id, ...doc.data() }));
        renderPhotos(items);
      });
    }

    sortSelect.addEventListener('change', ()=> subscribePhotos());
    searchInput.addEventListener('input', ()=> subscribePhotos());

    function renderPhotos(items){
      const q = (searchInput.value || '').toLowerCase().trim();
      const filtered = q ? items.filter(it=> {
        const name = (it.name||'').toLowerCase();
        const tags = (it.tags||[]).join(' ').toLowerCase();
        return name.includes(q) || tags.includes(q);
      }) : items;

      photoCount.textContent = String(filtered.length);
      if(filtered.length === 0){
        photoGrid.innerHTML = '';
        show(emptyState);
        return;
      }
      hide(emptyState);

      photoGrid.innerHTML = '';
      filtered.forEach(item=>{
        const div = document.createElement('div');
        div.className = 'card';
        div.title = item.name;
        
        // é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'select-checkbox';
        checkbox.onchange = () => toggleSelection(item.id, checkbox.checked);
        
        // ç”»åƒ
        const img = document.createElement('img');
        img.src = item.url;
        img.alt = item.name || 'photo';
        img.onclick = () => showImageModal(item.url, item.name, item.size, item.tags);
        
        // ç·¨é›†ãƒœã‚¿ãƒ³
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.innerHTML = 'âœ';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          editPhoto(item);
        };
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.innerHTML = 'Ã—';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          deletePhoto(item);
        };
        
        // ç”»åƒæƒ…å ±
        const info = document.createElement('div');
        info.className = 'card-info';
        
        const folderName = folders.find(f => f.id === item.folder)?.name || '';
        const tagsHtml = (item.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('');
        
        info.innerHTML = `
          <div class="card-name">${item.name}</div>
          <div>${(item.size/1024/1024).toFixed(1)}MB</div>
          ${folderName ? `<div class="card-folder">ğŸ“ ${folderName}</div>` : ''}
          <div class="card-tags">${tagsHtml}</div>
        `;
        
        div.appendChild(checkbox);
        div.appendChild(img);
        div.appendChild(editBtn);
        div.appendChild(delBtn);
        div.appendChild(info);
        photoGrid.appendChild(div);
      });
    }

    // ========= ç”»åƒè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« =========
    function showImageModal(url, name, size, tags) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      
      const img = document.createElement('img');
      img.src = url;
      img.alt = name;
      
      const info = document.createElement('div');
      info.className = 'modal-info';
      const tagsText = tags && tags.length ? ` | ã‚¿ã‚°: ${tags.join(', ')}` : '';
      info.textContent = `${name} (${(size/1024/1024).toFixed(1)}MB)${tagsText}`;
      
      modal.appendChild(img);
      modal.appendChild(info);
      
      modal.onclick = () => modal.remove();
      document.body.appendChild(modal);
    }

    // ========= é¸æŠç®¡ç† =========
    function toggleSelection(photoId, selected) {
      if(selected) {
        selectedPhotos.add(photoId);
      } else {
        selectedPhotos.delete(photoId);
      }
      updateSelectionUI();
    }

    function updateSelectionUI() {
      const count = selectedPhotos.size;
      if(count > 0) {
        bulkActions.classList.add('show');
        bulkCount.textContent = `${count}ä»¶é¸æŠä¸­`;
        selectedCount.textContent = `(${count}ä»¶é¸æŠ)`;
        show(selectedCount);
      } else {
        bulkActions.classList.remove('show');
        hide(selectedCount);
      }
    }

    btnClearSelection.addEventListener('click', () => {
      selectedPhotos.clear();
      document.querySelectorAll('.select-checkbox').forEach(cb => cb.checked = false);
      updateSelectionUI();
    });

    // ========= å‰Šé™¤æ©Ÿèƒ½ =========
    async function deletePhoto(item) {
      if (!confirm(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      
      try {
        await storage.ref(item.storagePath).delete();
        await db.collection('users').doc(auth.currentUser.uid)
          .collection('photos').doc(item.id).delete();
        toast('å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
      } catch(error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        toast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // ========= ç”»åƒç·¨é›† =========
    let editCtx, originalImage;

    function editPhoto(item) {
      currentEditItem = item;
      editName.value = item.name || '';
      editFolder.value = item.folder || '';
      editTags.value = (item.tags || []).join(', ');
      
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ç”»åƒèª­ã¿è¾¼ã¿
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        editCanvas.width = Math.min(400, img.width);
        editCanvas.height = (img.height * editCanvas.width) / img.width;
        editCtx = editCanvas.getContext('2d');
        originalImage = img;
        drawEditImage();
      };
      img.src = item.url;
      
      show(editModal);
    }

    let rotation = 0, flipH = 1, flipV = 1, brightness = 100, contrast = 100;

    function drawEditImage() {
      if(!editCtx || !originalImage) return;
      
      editCtx.clearRect(0, 0, editCanvas.width, editCanvas.height);
      editCtx.save();
      
      // å¤‰å½¢ã®ä¸­å¿ƒç‚¹
      editCtx.translate(editCanvas.width/2, editCanvas.height/2);
      editCtx.rotate(rotation * Math.PI / 180);
      editCtx.scale(flipH, flipV);
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
      editCtx.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
      
      editCtx.drawImage(originalImage, -editCanvas.width/2, -editCanvas.height/2, editCanvas.width, editCanvas.height);
      editCtx.restore();
    }

    // ç·¨é›†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    document.getElementById('btnRotate').onclick = () => { rotation += 90; drawEditImage(); };
    document.getElementById('btnFlipH').onclick = () => { flipH *= -1; drawEditImage(); };
    document.getElementById('btnFlipV').onclick = () => { flipV *= -1; drawEditImage(); };
    document.getElementById('btnReset').onclick = () => { 
      rotation = 0; flipH = 1; flipV = 1; brightness = 100; contrast = 100;
      document.getElementById('brightness').value = 100;
      document.getElementById('contrast').value = 100;
      drawEditImage(); 
    };

    document.getElementById('brightness').oninput = (e) => { brightness = e.target.value; drawEditImage(); };
    document.getElementById('contrast').oninput = (e) => { contrast = e.target.value; drawEditImage(); };

    btnCancelEdit.addEventListener('click', () => hide(editModal));

    btnSaveEdit.addEventListener('click', async () => {
      if(!currentEditItem) return;
      
      try {
        const user = auth.currentUser;
        const updates = {
          name: editName.value || currentEditItem.name,
          folder: editFolder.value || '',
          tags: editTags.value.split(',').map(t => t.trim()).filter(t => t)
        };
        
        // ç”»åƒãŒç·¨é›†ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ–°ã—ã„ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if(rotation !== 0 || flipH !== 1 || flipV !== 1 || brightness !== 100 || contrast !== 100) {
          const canvas = editCanvas;
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
          const path = `users/${user.uid}/edited-${Date.now()}.jpg`;
          const ref = storage.ref(path);
          await ref.put(blob);
          const newUrl = await ref.getDownloadURL();
          
          // å¤ã„ç”»åƒã‚’å‰Šé™¤
          try { await storage.ref(currentEditItem.storagePath).delete(); } catch(e) {}
          
          updates.url = newUrl;
          updates.storagePath = path;
        }
        
        await db.collection('users').doc(user.uid)
          .collection('photos').doc(currentEditItem.id).update(updates);
        
        hide(editModal);
        toast('ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      } catch(e) {
        toast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    });

    // ========= ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ =========
    btnBulkDownload.addEventListener('click', async () => {
      if(selectedPhotos.size === 0) {
        toast('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      toast('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­...', 'info');
      
      try {
        for(const photoId of selectedPhotos) {
          // ç°¡æ˜“ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®ZIPåŒ–ã¯è¤‡é›‘ãªã®ã§å€‹åˆ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
          const photoDoc = await db.collection('users').doc(auth.currentUser.uid)
            .collection('photos').doc(photoId).get();
          
          if(photoDoc.exists) {
            const data = photoDoc.data();
            const a = document.createElement('a');
            a.href = data.url;
            a.download = data.name;
            a.click();
            await sleep(500); // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–“éš”
          }
        }
        toast('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹', 'success');
      } catch(e) {
        toast('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    });

    // ========= ä¸€æ‹¬æ“ä½œ =========
    document.getElementById('btnBulkDelete').addEventListener('click', async () => {
      if(!confirm(`é¸æŠã—ãŸ${selectedPhotos.size}ä»¶ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      
      try {
        for(const photoId of selectedPhotos) {
          const photoDoc = await db.collection('users').doc(auth.currentUser.uid)
            .collection('photos').doc(photoId).get();
          
          if(photoDoc.exists) {
            const data = photoDoc.data();
            await storage.ref(data.storagePath).delete();
            await photoDoc.ref.delete();
          }
        }
        selectedPhotos.clear();
        updateSelectionUI();
        toast('ä¸€æ‹¬å‰Šé™¤å®Œäº†', 'success');
      } catch(e) {
        toast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    });

    document.getElementById('btnBulkMove').addEventListener('click', async () => {
      const targetFolder = prompt('ç§»å‹•å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„\n\n' + 
        folders.map(f => f.name).join('\n') + 
        '\n\n(ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã€ç©ºç™½ã§ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€)');
      
      if(targetFolder === null) return;
      
      const folder = folders.find(f => f.name === targetFolder);
      const folderId = folder ? folder.id : '';
      
      try {
        for(const photoId of selectedPhotos) {
          await db.collection('users').doc(auth.currentUser.uid)
            .collection('photos').doc(photoId).update({ folder: folderId });
        }
        selectedPhotos.clear();
        updateSelectionUI();
        toast('ç§»å‹•å®Œäº†', 'success');
      } catch(e) {
        toast('ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    });

    document.getElementById('btnBulkTag').addEventListener('click', async () => {
      const newTags = prompt('è¿½åŠ ã™ã‚‹ã‚¿ã‚°ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„\nä¾‹: æ—…è¡Œ,å¤,é¢¨æ™¯');
      if(!newTags) return;
      
      const tags = newTags.split(',').map(t => t.trim()).filter(t => t);
      
      try {
        for(const photoId of selectedPhotos) {
          const photoDoc = await db.collection('users').doc(auth.currentUser.uid)
            .collection('photos').doc(photoId).get();
          
          if(photoDoc.exists) {
            const currentTags = photoDoc.data().tags || [];
            const updatedTags = [...new Set([...currentTags, ...tags])];
            await photoDoc.ref.update({ tags: updatedTags });
          }
        }
        selectedPhotos.clear();
        updateSelectionUI();
        toast('ã‚¿ã‚°è¿½åŠ å®Œäº†', 'success');
      } catch(e) {
        toast('ã‚¿ã‚°è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    folderModal.addEventListener('click', (e) => {
      if(e.target === folderModal) hide(folderModal);
    });
    editModal.addEventListener('click', (e) => {
      if(e.target === editModal) hide(editModal);
    });
  </script>
</body>
</html>
