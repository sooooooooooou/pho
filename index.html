<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo Manager Â· Firebase Sync</title>
  <style>
    :root {
      --bg: #0f1115;
      --card: #151821;
      --muted: #aab2c0;
      --text: #e9edf1;
      --acc: #4ea1ff;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 14px 16px;
      background: #0c0e12;
      border-bottom: 1px solid #1e2230;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .btn {
      appearance: none;
      border: 1px solid #2a3040;
      background: #1a1f2b;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn:hover {
      border-color: #3b4256;
    }

    .btn.primary {
      background: var(--acc);
      color: white;
      border-color: transparent;
    }

    .btn.success {
      background: #22c55e;
      color: white;
      border-color: transparent;
    }

    .btn.ghost {
      background: transparent;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .card {
      background: var(--card);
      border: 1px solid #1f2432;
      border-radius: 14px;
      overflow: hidden;
      position: relative;
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .card > img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
      background: #0b0d11;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .card > img:hover {
      opacity: 0.8;
    }

    .delete-btn,
    .edit-btn {
      position: absolute;
      top: 8px;
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .delete-btn {
      right: 8px;
      background: rgba(255, 100, 124, 0.9);
    }

    .edit-btn {
      right: 42px;
      background: rgba(78, 161, 255, 0.9);
      font-size: 12px;
    }

    .card:hover .delete-btn,
    .card:hover .edit-btn {
      opacity: 1;
    }

    .delete-btn:hover {
      background: rgba(255, 100, 124, 1);
    }

    .edit-btn:hover {
      background: rgba(78, 161, 255, 1);
    }

    .select-checkbox {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 20px;
      height: 20px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .card:hover .select-checkbox {
      opacity: 1;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      cursor: pointer;
    }

    .modal img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 8px;
    }

    .modal-info {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      max-width: 80%;
      text-align: center;
    }

    .card-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      color: white;
      padding: 12px 10px 8px;
      font-size: 11px;
      line-height: 1.3;
    }

    .card-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .tag {
      font-size: 11px;
      padding: 2px 6px;
      border: 1px solid var(--acc);
      border-radius: 999px;
      color: var(--acc);
      background: rgba(78, 161, 255, 0.1);
      margin: 2px;
    }

    .card-folder {
      font-size: 10px;
      opacity: 0.8;
    }

    .muted {
      color: var(--muted);
    }

    .hidden {
      display: none !important;
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    input, select, textarea {
      background: #161a24;
      color: var(--text);
      border: 1px solid #2a3040;
      border-radius: 10px;
      padding: 9px 12px;
      outline: none;
      width: 100%;
    }

    input[type="file"] {
      padding: 12px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 16px;
    }

    .folder-nav {
      display: flex;
      gap: 4px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .folder-btn {
      background: var(--card);
      border: 1px solid #2a3040;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    .folder-btn.active {
      background: var(--acc);
      color: white;
      border-color: transparent;
    }
  </style>
</head>
<body>
  <header>
    <div class="row" style="gap:12px">
      <strong>Photo Manager</strong>
      <span id="authState" class="chip">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
    </div>
    <div class="row" style="gap:8px">
      <button id="btnToggleDebug" class="btn ghost" aria-label="ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º">Debug</button>
      <button id="btnOpenSettings" class="btn ghost" aria-label="è¨­å®šã‚’é–‹ã">è¨­å®š</button>
      <button id="btnLogin" class="btn primary" aria-label="ãƒ­ã‚°ã‚¤ãƒ³">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button id="btnLogout" class="btn hidden" aria-label="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <main class="wrap stack">
    <!-- èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <section id="authModal" class="card hidden" style="padding:16px;max-width:460px;margin:0 auto">
      <h3 style="margin:0 0 6px">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h3>
      <p class="muted" style="margin:0 0 12px">ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚åˆã‚ã¦ãªã‚‰ãã®ã¾ã¾ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
      <form id="authForm" class="stack">
        <input id="email" type="email" aria-label="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹: you@example.comï¼‰" required />
        <input id="password" type="password" aria-label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰" minlength="6" required />
        <div class="row" style="justify-content:space-between">
          <button type="submit" class="btn primary" id="btnEmailLogin" aria-label="ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³">ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button type="button" class="btn" id="btnRegister" aria-label="æ–°è¦ç™»éŒ²">æ–°è¦ç™»éŒ²</button>
        </div>
        <div class="row" style="gap:8px;align-items:center;justify-content:center"><span class="muted">ã¾ãŸã¯</span></div>
        <button type="button" class="btn" id="btnGoogle" aria-label="Googleã§ãƒ­ã‚°ã‚¤ãƒ³">Googleã§ç¶šè¡Œ</button>
      </form>
      <p id="authError" class="danger" style="min-height:1.2em"></p>
    </section>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section id="appSection" class="stack hidden">
      <div class="toolbar">
        <button id="btnSelectFiles" class="btn primary">+ ç”»åƒã‚’è¿½åŠ </button>
        <button id="btnUpload" class="btn success hidden" disabled>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <button id="btnCreateFolder" class="btn ghost">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</button>
        <span id="uploadHint" class="muted">å†™çœŸã‚’é¸ã¶ã¨è‡ªå‹•ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ (æœ€å¤§10æš)</span>
        <input id="fileInput" type="file" accept="image/*" multiple hidden>
      </div>

      <div id="progressBox" class="progress hidden"><div id="progressBar"></div></div>
      <div id="folderNav" class="folder-nav"></div>

      <div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:8px">
        <div class="row" style="gap:10px">
          <span class="muted">åˆè¨ˆ:</span>
          <strong id="photoCount">0</strong>
          <span id="selectedCount" class="muted hidden"></span>
        </div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <select id="sortSelect">
            <option value="createdAt_desc">æ–°ã—ã„é †</option>
            <option value="createdAt_asc">å¤ã„é †</option>
            <option value="name_asc">åå‰ Aâ†’Z</option>
            <option value="name_desc">åå‰ Zâ†’A</option>
          </select>
          <input id="searchInput" placeholder="åå‰ãƒ»ã‚¿ã‚°ã§æ¤œç´¢" style="min-width:200px" />
          <button id="btnBulkDownload" class="btn ghost">ä¸€æ‹¬DL</button>
        </div>
      </div>

      <div id="photoGrid" class="grid"></div>
      <div id="emptyState" class="center muted" style="padding:40px">ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ã€Œ+ ç”»åƒã‚’è¿½åŠ ã€ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã­ã€‚</div>
    </section>

    <!-- ç”»åƒç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editModal" class="form-modal hidden">
      <div class="form-modal-content">
        <h3 style="margin:0 0 16px">ç”»åƒç·¨é›†</h3>
        <div class="stack">
          <input id="editName" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«å" />
          <select id="editFolder"><option value="">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</option></select>
          <input id="editTags" placeholder="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ä¾‹: é¢¨æ™¯,æ—…è¡Œ,å¤" />

          <div class="canvas-container">
            <canvas id="editCanvas" style="max-width:100%;border:1px solid #2a3040;border-radius:8px"></canvas>
          </div>

          <div class="edit-controls">
            <button id="btnRotate" class="btn">å›è»¢</button>
            <button id="btnFlipH" class="btn">å·¦å³åè»¢</button>
            <button id="btnFlipV" class="btn">ä¸Šä¸‹åè»¢</button>
            <button id="btnReset" class="btn ghost">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>

          <div class="row">
            <label style="flex:1">æ˜åº¦: <input id="brightness" type="range" min="0" max="200" value="100"></label>
            <label style="flex:1">ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ: <input id="contrast" type="range" min="0" max="200" value="100"></label>
          </div>

          <div class="row" style="gap:8px;justify-content:flex-end;margin-top:16px">
            <button id="btnPreviewSave" class="btn">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¿å­˜</button>
            <button id="btnCancelEdit" class="btn ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="btnSaveEdit" class="btn success">ä¿å­˜</button>
          </div>
        </div>
      </div>
    </div>
  </main>
</body>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBCkkQGoq6xm9gIi3SXD5ACWyF09_cXo4A",
  authDomain: "phote-ec8f0.firebaseapp.com",
  projectId: "phote-ec8f0",
  storageBucket: "phote-ec8f0.appspot.com",
  messagingSenderId: "325922770311",
  appId: "1:325922770311:web:a39493565961d7ae861722"
};

const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

function applyTheme(mode){
  if(mode === 'light'){
    document.documentElement.style.setProperty('--bg','#f6f7fb');
    document.documentElement.style.setProperty('--card','#ffffff');
    document.documentElement.style.setProperty('--text','#0d1117');
    document.documentElement.style.setProperty('--muted','#516079');
    document.documentElement.style.setProperty('--acc','#2563eb');
  } else {
    document.documentElement.style.setProperty('--bg','#0f1115');
    document.documentElement.style.setProperty('--card','#151821');
    document.documentElement.style.setProperty('--text','#e9edf1');
    document.documentElement.style.setProperty('--muted','#aab2c0');
    document.documentElement.style.setProperty('--acc','#4ea1ff');
  }
}

// ãƒ•ã‚©ãƒ«ãƒ€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‰ãƒ©ãƒƒã‚°å¯¾å¿œï¼‰
function renderFolderNav() {
  folderNav.innerHTML = "<button class='folder-btn active' data-folder='' ondragover='event.preventDefault()' ondrop='handleDrop(event, \"\")'>ã™ã¹ã¦</button>";
  folders.forEach(folder => {
    const btn = document.createElement('button');
    btn.className = 'folder-btn';
    btn.dataset.folder = folder.id;
    btn.textContent = folder.name;
    btn.ondragover = (e) => e.preventDefault();
    btn.ondrop = (e) => handleDrop(e, folder.id);
    folderNav.appendChild(btn);
  });
}

function handleDrop(event, targetFolderId) {
  const photoId = event.dataTransfer.getData('text/plain');
  db.collection('users').doc(auth.currentUser.uid)
    .collection('photos').doc(photoId).update({ folder: targetFolderId })
    .then(() => toast('ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¾ã—ãŸ', 'success'))
    .catch(e => toast(`ç§»å‹•å¤±æ•—: ${e.message}`, 'error'));
}

// ç·¨é›†ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¿å­˜
document.getElementById('btnPreviewSave').addEventListener('click', () => {
  editCanvas.toBlob(blob => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'preview.jpg';
    a.click();
    toast('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
  }, 'image/jpeg', 0.9);
});

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼ˆä¾‹ï¼šç™»éŒ²ï¼‰
btnRegister.addEventListener('click', async ()=> {
  authError.textContent = '';
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  try{
    await auth.createUserWithEmailAndPassword(email, password);
    const uid = auth.currentUser.uid;
    await db.collection('users').doc(uid).set({
      settings: { theme:'dark' },
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
    hide(authModal);
  }catch(err){ 
    authError.textContent = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message;
    toast('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
  }
});

// img è¦ç´ ã«è¿½åŠ ï¼ˆãƒ‰ãƒ©ãƒƒã‚°å¯¾å¿œï¼‰
// ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ renderPhotos é–¢æ•°å†…ã§å„ç”»åƒã«å¯¾ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„
img.draggable = true;
img.ondragstart = (e) => {
  e.dataTransfer.setData('text/plain', item.id);
};
</script>
</html>
