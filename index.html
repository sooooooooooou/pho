<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo Manager · Firebase Sync</title>
  <style>
    :root {
      --bg: #0f1115;
      --card: #151821;
      --muted: #aab2c0;
      --text: #e9edf1;
      --acc: #4ea1ff;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 14px 16px;
      background: #0c0e12;
      border-bottom: 1px solid #1e2230;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .btn {
      appearance: none;
      border: 1px solid #2a3040;
      background: #1a1f2b;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn:hover {
      border-color: #3b4256;
    }

    .btn.primary {
      background: var(--acc);
      color: white;
      border-color: transparent;
    }

    .btn.success {
      background: #22c55e;
      color: white;
      border-color: transparent;
    }

    .btn.ghost {
      background: transparent;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .card {
      background: var(--card);
      border: 1px solid #1f2432;
      border-radius: 14px;
      overflow: hidden;
      position: relative;
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .card > img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
      background: #0b0d11;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .card > img:hover {
      opacity: 0.8;
    }

    .delete-btn,
    .edit-btn {
      position: absolute;
      top: 8px;
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .delete-btn {
      right: 8px;
      background: rgba(255, 100, 124, 0.9);
    }

    .edit-btn {
      right: 42px;
      background: rgba(78, 161, 255, 0.9);
      font-size: 12px;
    }

    .card:hover .delete-btn,
    .card:hover .edit-btn {
      opacity: 1;
    }

    .delete-btn:hover {
      background: rgba(255, 100, 124, 1);
    }

    .edit-btn:hover {
      background: rgba(78, 161, 255, 1);
    }

    .select-checkbox {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 20px;
      height: 20px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .card:hover .select-checkbox {
      opacity: 1;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      cursor: pointer;
    }

    .modal img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 8px;
    }

    .modal-info {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      max-width: 80%;
      text-align: center;
    }

    .card-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      color: white;
      padding: 12px 10px 8px;
      font-size: 11px;
      line-height: 1.3;
    }

    .card-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .tag {
      font-size: 11px;
      padding: 2px 6px;
      border: 1px solid var(--acc);
      border-radius: 999px;
      color: var(--acc);
      background: rgba(78, 161, 255, 0.1);
      margin: 2px;
    }

    .card-folder {
      font-size: 10px;
      opacity: 0.8;
    }

    .muted {
      color: var(--muted);
    }

    .hidden {
      display: none !important;
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    input, select, textarea {
      background: #161a24;
      color: var(--text);
      border: 1px solid #2a3040;
      border-radius: 10px;
      padding: 9px 12px;
      outline: none;
      width: 100%;
    }

    input[type="file"] {
      padding: 12px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 16px;
    }

    .folder-nav {
      display: flex;
      gap: 4px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .folder-btn {
      background: var(--card);
      border: 1px solid #2a3040;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    .folder-btn.active {
      background: var(--acc);
      color: white;
      border-color: transparent;
    }
  </style>
</head>
<body>
  <header>
    <div class="row" style="gap:12px">
      <strong>Photo Manager</strong>
      <span id="authState" class="chip">未ログイン</span>
    </div>
    <div class="row" style="gap:8px">
      <button id="btnToggleDebug" class="btn ghost" aria-label="デバッグ表示">Debug</button>
      <button id="btnOpenSettings" class="btn ghost" aria-label="設定を開く">設定</button>
      <button id="btnLogin" class="btn primary" aria-label="ログイン">ログイン</button>
      <button id="btnLogout" class="btn hidden" aria-label="ログアウト">ログアウト</button>
    </div>
  </header>

  <main class="wrap stack">
    <!-- 認証モーダル -->
    <section id="authModal" class="card hidden" style="padding:16px;max-width:460px;margin:0 auto">
      <h3 style="margin:0 0 6px">ログイン / 新規登録</h3>
      <p class="muted" style="margin:0 0 12px">メールとパスワードでログインできます。初めてならそのまま登録してください。</p>
      <form id="authForm" class="stack">
        <input id="email" type="email" aria-label="メールアドレス" placeholder="メールアドレス（例: you@example.com）" required />
        <input id="password" type="password" aria-label="パスワード" placeholder="パスワード（6文字以上）" minlength="6" required />
        <div class="row" style="justify-content:space-between">
          <button type="submit" class="btn primary" id="btnEmailLogin" aria-label="メールでログイン">メールでログイン</button>
          <button type="button" class="btn" id="btnRegister" aria-label="新規登録">新規登録</button>
        </div>
        <div class="row" style="gap:8px;align-items:center;justify-content:center"><span class="muted">または</span></div>
        <button type="button" class="btn" id="btnGoogle" aria-label="Googleでログイン">Googleで続行</button>
      </form>
      <p id="authError" class="danger" style="min-height:1.2em"></p>
    </section>

    <!-- メインアプリセクション -->
    <section id="appSection" class="stack hidden">
      <div class="toolbar">
        <button id="btnSelectFiles" class="btn primary">+ 画像を追加</button>
        <button id="btnUpload" class="btn success hidden" disabled>アップロード</button>
        <button id="btnCreateFolder" class="btn ghost">📁 フォルダ作成</button>
        <span id="uploadHint" class="muted">写真を選ぶと自動でアップロードされます (最大10枚)</span>
        <input id="fileInput" type="file" accept="image/*" multiple hidden>
      </div>

      <div id="progressBox" class="progress hidden"><div id="progressBar"></div></div>
      <div id="folderNav" class="folder-nav"></div>

      <div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:8px">
        <div class="row" style="gap:10px">
          <span class="muted">合計:</span>
          <strong id="photoCount">0</strong>
          <span id="selectedCount" class="muted hidden"></span>
        </div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <select id="sortSelect">
            <option value="createdAt_desc">新しい順</option>
            <option value="createdAt_asc">古い順</option>
            <option value="name_asc">名前 A→Z</option>
            <option value="name_desc">名前 Z→A</option>
          </select>
          <input id="searchInput" placeholder="名前・タグで検索" style="min-width:200px" />
          <button id="btnBulkDownload" class="btn ghost">一括DL</button>
        </div>
      </div>

      <div id="photoGrid" class="grid"></div>
      <div id="emptyState" class="center muted" style="padding:40px">まだ写真がありません。上の「+ 画像を追加」からアップロードしてね。</div>
    </section>

    <!-- 画像編集モーダル -->
    <div id="editModal" class="form-modal hidden">
      <div class="form-modal-content">
        <h3 style="margin:0 0 16px">画像編集</h3>
        <div class="stack">
          <input id="editName" placeholder="ファイル名" />
          <select id="editFolder"><option value="">フォルダを選択</option></select>
          <input id="editTags" placeholder="タグ（カンマ区切り）例: 風景,旅行,夏" />

          <div class="canvas-container">
            <canvas id="editCanvas" style="max-width:100%;border:1px solid #2a3040;border-radius:8px"></canvas>
          </div>

          <div class="edit-controls">
            <button id="btnRotate" class="btn">回転</button>
            <button id="btnFlipH" class="btn">左右反転</button>
            <button id="btnFlipV" class="btn">上下反転</button>
            <button id="btnReset" class="btn ghost">リセット</button>
          </div>

          <div class="row">
            <label style="flex:1">明度: <input id="brightness" type="range" min="0" max="200" value="100"></label>
            <label style="flex:1">コントラスト: <input id="contrast" type="range" min="0" max="200" value="100"></label>
          </div>

          <div class="row" style="gap:8px;justify-content:flex-end;margin-top:16px">
            <button id="btnPreviewSave" class="btn">プレビュー保存</button>
            <button id="btnCancelEdit" class="btn ghost">キャンセル</button>
            <button id="btnSaveEdit" class="btn success">保存</button>
          </div>
        </div>
      </div>
    </div>
  </main>
</body>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBCkkQGoq6xm9gIi3SXD5ACWyF09_cXo4A",
  authDomain: "phote-ec8f0.firebaseapp.com",
  projectId: "phote-ec8f0",
  storageBucket: "phote-ec8f0.appspot.com",
  messagingSenderId: "325922770311",
  appId: "1:325922770311:web:a39493565961d7ae861722"
};

const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

function applyTheme(mode){
  if(mode === 'light'){
    document.documentElement.style.setProperty('--bg','#f6f7fb');
    document.documentElement.style.setProperty('--card','#ffffff');
    document.documentElement.style.setProperty('--text','#0d1117');
    document.documentElement.style.setProperty('--muted','#516079');
    document.documentElement.style.setProperty('--acc','#2563eb');
  } else {
    document.documentElement.style.setProperty('--bg','#0f1115');
    document.documentElement.style.setProperty('--card','#151821');
    document.documentElement.style.setProperty('--text','#e9edf1');
    document.documentElement.style.setProperty('--muted','#aab2c0');
    document.documentElement.style.setProperty('--acc','#4ea1ff');
  }
}

// フォルダナビゲーション（ドラッグ対応）
function renderFolderNav() {
  folderNav.innerHTML = "<button class='folder-btn active' data-folder='' ondragover='event.preventDefault()' ondrop='handleDrop(event, \"\")'>すべて</button>";
  folders.forEach(folder => {
    const btn = document.createElement('button');
    btn.className = 'folder-btn';
    btn.dataset.folder = folder.id;
    btn.textContent = folder.name;
    btn.ondragover = (e) => e.preventDefault();
    btn.ondrop = (e) => handleDrop(e, folder.id);
    folderNav.appendChild(btn);
  });
}

function handleDrop(event, targetFolderId) {
  const photoId = event.dataTransfer.getData('text/plain');
  db.collection('users').doc(auth.currentUser.uid)
    .collection('photos').doc(photoId).update({ folder: targetFolderId })
    .then(() => toast('フォルダに移動しました', 'success'))
    .catch(e => toast(`移動失敗: ${e.message}`, 'error'));
}

// 編集画像のプレビュー保存
document.getElementById('btnPreviewSave').addEventListener('click', () => {
  editCanvas.toBlob(blob => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'preview.jpg';
    a.click();
    toast('プレビュー画像を保存しました', 'success');
  }, 'image/jpeg', 0.9);
});

// エラーハンドリング強化（例：登録）
btnRegister.addEventListener('click', async ()=> {
  authError.textContent = '';
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  try{
    await auth.createUserWithEmailAndPassword(email, password);
    const uid = auth.currentUser.uid;
    await db.collection('users').doc(uid).set({
      settings: { theme:'dark' },
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
    hide(authModal);
  }catch(err){ 
    authError.textContent = '登録に失敗しました: ' + err.message;
    toast('登録に失敗しました: ' + err.message, 'error');
  }
});

// img 要素に追加（ドラッグ対応）
// このコードは renderPhotos 関数内で各画像に対して追加してください
img.draggable = true;
img.ondragstart = (e) => {
  e.dataTransfer.setData('text/plain', item.id);
};
</script>
</html>
